%%{init: {'theme':'base', 'themeVariables': { 'primaryColor':'#e3f2fd','primaryTextColor':'#000','primaryBorderColor':'#1976d2','lineColor':'#1976d2','secondaryColor':'#fff3e0','tertiaryColor':'#f3e5f5'}}}%%

flowchart TB
    Start([ğŸš€ Webhook<br/>Recebe Tarefa]) --> Normalize[ğŸ“‹ Normalizar Entrada<br/><small>Valida campos obrigatÃ³rios<br/>Adiciona valores padrÃ£o</small>]
    
    Normalize --> Memory[ğŸ§  Consultar MemÃ³ria<br/>e Aprendizados<br/><small>Camadas 1, 2, 4 do RAG</small>]
    Normalize --> Data[ğŸ“Š Consultar Dados<br/>PostgreSQL<br/><small>Indicadores econÃ´micos brutos</small>]
    
    Memory --> Context[âš™ï¸ Preparar Contexto<br/>para LLM V3<br/><small>Integra memÃ³ria + dados</small>]
    Data --> Context
    
    Context --> Generate[ğŸ¤– Gerar AnÃ¡lise<br/>com OpenAI<br/><small>GPT-4 com contexto evolutivo</small>]
    
    Generate --> Structure[ğŸ“ Estruturar<br/>Resposta<br/><small>Formata JSON padronizado</small>]
    
    Structure --> Prepare[ğŸ”§ Preparar Dados<br/>para Salvar V2<br/><small>ExtraÃ§Ã£o segura e resiliente</small>]
    
    Prepare --> Save[ğŸ’¾ Salvar AnÃ¡lise<br/>no PostgreSQL<br/><small>Camada 1: agent_econ_memory</small>]
    
    Save --> Learn[ğŸ“ Registrar Aprendizado<br/><small>Camada 2: learning_evolution</small>]
    
    Learn --> Expertise[ğŸ“ˆ Atualizar Expertise<br/><small>Camada 4: get_agent_expertise</small>]
    
    Expertise --> Audit[ğŸ“‹ Registrar Auditoria<br/><small>audit_trail</small>]
    
    Audit --> Response([âœ… Respond to<br/>Webhook<br/><small>Retorna anÃ¡lise completa</small>])
    
    Generate -.->|Erro| Error[âŒ Responder Erro]
    Error --> ErrorResponse([ğŸš« Erro ao Webhook])
    
    %% Estilos
    classDef inputNode fill:#e3f2fd,stroke:#1976d2,stroke-width:3px,color:#000
    classDef memoryNode fill:#fff3e0,stroke:#f57c00,stroke-width:3px,color:#000
    classDef dataNode fill:#e8f5e9,stroke:#388e3c,stroke-width:3px,color:#000
    classDef processNode fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px,color:#000
    classDef aiNode fill:#fce4ec,stroke:#c2185b,stroke-width:3px,color:#000
    classDef saveNode fill:#e0f2f1,stroke:#00796b,stroke-width:3px,color:#000
    classDef learningNode fill:#fff9c4,stroke:#f57f17,stroke-width:3px,color:#000
    classDef outputNode fill:#c8e6c9,stroke:#388e3c,stroke-width:3px,color:#000
    classDef errorNode fill:#ffcdd2,stroke:#c62828,stroke-width:2px,color:#000
    
    class Start inputNode
    class Normalize processNode
    class Memory memoryNode
    class Data dataNode
    class Context processNode
    class Generate aiNode
    class Structure processNode
    class Prepare processNode
    class Save saveNode
    class Learn learningNode
    class Expertise learningNode
    class Audit saveNode
    class Response outputNode
    class Error,ErrorResponse errorNode
    
    %% AnotaÃ§Ãµes
    subgraph RAG["ğŸ§  ARQUITETURA RAG EVOLUTIVA"]
        Memory
        Learn
        Expertise
    end
    
    subgraph Analysis["ğŸ“Š GERAÃ‡ÃƒO DE ANÃLISE"]
        Context
        Generate
        Structure
    end
    
    subgraph Persistence["ğŸ’¾ PERSISTÃŠNCIA E EVOLUÃ‡ÃƒO"]
        Save
        Learn
        Expertise
        Audit
    end
    
    style RAG fill:#fff3e0,stroke:#f57c00,stroke-width:2px,stroke-dasharray: 5 5
    style Analysis fill:#fce4ec,stroke:#c2185b,stroke-width:2px,stroke-dasharray: 5 5
    style Persistence fill:#e0f2f1,stroke:#00796b,stroke-width:2px,stroke-dasharray: 5 5
