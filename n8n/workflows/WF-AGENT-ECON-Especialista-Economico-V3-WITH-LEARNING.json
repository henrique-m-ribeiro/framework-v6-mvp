{
  "name": "WF-AGENT-ECON - Especialista Econ√¥mico V3 (com Aprendizagem)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "agent-econ",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "de732c22-107b-4fc6-a796-8d273316bb6a",
      "name": "Webhook - Recebe Tarefa",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -32,
        0
      ],
      "webhookId": "agent-econ-webhook",
      "notes": "FUN√á√ÉO: Ponto de entrada do Agente ECON.\n\nATUALIZA√á√ïES V2:\n- typeVersion: 1 ‚Üí 2 (vers√£o mais recente)\n- Adicionado: ignoreBots: true (ignora bots e crawlers)\n- Mantido: CORS permitido (*) para testes\n\nRECEBE: Requisi√ß√£o HTTP POST do Orquestrador com:\n- task_id: ID √∫nico da tarefa\n- territory_id: ID do territ√≥rio a analisar\n- territory_name: Nome do territ√≥rio\n- dimension: 'economic'\n- task_description: Descri√ß√£o da an√°lise solicitada\n- context: Contexto adicional (compara√ß√µes, per√≠odo, etc.)\n\nEXEMPLO DE PAYLOAD:\n{\n  \"task_id\": \"uuid-12345\",\n  \"territory_id\": 1,\n  \"territory_name\": \"Palmas\",\n  \"dimension\": \"economic\",\n  \"task_description\": \"Analisar evolu√ß√£o econ√¥mica de Palmas (2019-2023)\",\n  \"context\": {\n    \"user_question\": \"Como est√° a economia de Palmas?\",\n    \"comparison_territories\": [],\n    \"time_range\": \"2019-2023\"\n  }\n}\n\nCONFIGURA√á√ïES:\n- M√©todo: POST (para receber dados)\n- Path: /agent-econ (URL ser√° https://galactic-ai.app.n8n.cloud/webhook/agent-econ)\n- Response Mode: responseNode (resposta ser√° enviada por n√≥ espec√≠fico)\n- CORS: Permitido de qualquer origem (para testes)\n- Ignore Bots: true (reduz ru√≠do de crawlers)"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT \n  t.id AS territory_id,\n  t.name AS territory_name,\n  t.type AS territory_type,\n  t.area AS territory_area_km2,\n  ei.year,\n  ei.gdp AS gdp_millions,\n  ei.gdp_per_capita,\n  ei.employment_rate,\n  ei.revenue AS municipal_revenue,\n  ei.sector_distribution,\n  'economic' AS dimension,\n  'IBGE, SICONFI, RAIS' AS data_sources\nFROM territories t\nLEFT JOIN economic_indicators ei ON t.id = ei.territory_id\nWHERE t.id = '{{ $('Webhook - Recebe Tarefa').first().json.body.territory_id }}'\n  AND ei.year >= 2019\n  AND ei.year <= 2023\nORDER BY ei.year DESC;\n",
        "options": {
          "queryBatching": "transaction"
        }
      },
      "id": "251ef152-05a2-4d73-b50f-16bf0cf121fc",
      "name": "Consultar Dados PostgreSQL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        176,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "SVnYhSNx3vXIzoYk",
          "name": "Postgres Replit"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "FUN√á√ÉO: Buscar todos os dados econ√¥micos do territ√≥rio no banco de dados.\n\nATUALIZA√á√ïES V2:\n- typeVersion: 1 ‚Üí 2.5 (vers√£o mais recente)\n- Query Parameters: Agora usa $1 (prepared statement) em vez de {{ }}\n- Query Batching: 'transaction' (garante atomicidade)\n- Output Large Numbers: 'text' (evita perda de precis√£o em n√∫meros grandes)\n\nO QUE FAZ:\n1. Consulta a tabela 'territories' para dados b√°sicos (nome, popula√ß√£o, √°rea)\n2. Faz JOIN com 'economic_indicators' para dados econ√¥micos (PIB, emprego, sal√°rios)\n3. Faz JOIN com 'financial_indicators' para finan√ßas p√∫blicas (receitas, despesas, d√≠vida)\n4. Filtra pelo territory_id recebido no webhook (usando prepared statement $1)\n5. Filtra pelo per√≠odo 2019-2023 (√∫ltimos 5 anos)\n6. Ordena por ano (crescente)\n\nBENEF√çCIOS DO PREPARED STATEMENT ($1):\n- Previne SQL injection\n- Melhor performance (query √© compilada uma vez)\n- Mais seguro que interpola√ß√£o direta\n\nRESULTADO ESPERADO:\nUma lista de objetos JSON, um para cada ano:\n[\n  {\n    \"territory_id\": 1,\n    \"territory_name\": \"Palmas\",\n    \"year\": 2019,\n    \"gdp_total\": \"12500000000\",\n    \"gdp_per_capita\": \"42300\",\n    \"formal_jobs\": \"85000\",\n    ...\n  },\n  { ... ano 2020 ... },\n  { ... ano 2021 ... },\n  { ... ano 2022 ... },\n  { ... ano 2023 ... }\n]\n\nPOR QUE 5 ANOS?\n- Permite identificar tend√™ncias de m√©dio prazo\n- Suficiente para an√°lises temporais sem sobrecarregar o LLM\n- Cobre per√≠odo pr√© e p√≥s-pandemia (importante para contexto)\n\nTRATAMENTO DE ERROS:\n- Se territory_id n√£o existir, retorna array vazio []\n- Se n√£o houver dados para algum ano, LEFT JOIN garante que territ√≥rio ainda aparece\n- Query Batching: 'transaction' garante rollback em caso de erro"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// N√ì: PREPARAR CONTEXTO PARA LLM\n// Framework de Intelig√™ncia Territorial V6.0\n// ============================================================================\n// FUN√á√ÉO: Receber dados do webhook e do PostgreSQL, formatar em prompt estruturado\n// INPUT: Webhook (body) + PostgreSQL (array de registros)\n// OUTPUT: Objeto com user_prompt, indicators_used, metadata\n// ============================================================================\n\n// Receber dados do webhook\nconst webhookData = $('Webhook - Recebe Tarefa').first().json.body;\n\n// Receber dados do PostgreSQL (ARRAY de registros)\n// ‚úÖ MUDAN√áA CR√çTICA: Usar .all() em vez de .first().json\nconst dbRecords = $('Consultar Dados PostgreSQL').all();\n\n// Extrair informa√ß√µes do webhook\nconst taskId = webhookData.task_id || 'unknown';\nconst agentName = webhookData.agent_name || 'ECON';\nconst territoryId = webhookData.territory_id || '';\nconst territoryName = webhookData.territory_name || '';\nconst territoryType = webhookData.territory_type || 'municipality';\nconst analysisType = webhookData.analysis_type || 'economic';\n\n// Extrair par√¢metros opcionais\nconst parameters = webhookData.parameters || {};\nconst focusAreas = parameters.focus_areas || ['PIB', 'emprego', 'renda'];\nconst timePeriod = parameters.time_period || '2019-2023';\nconst detailLevel = parameters.detail_level || 'comprehensive';\n\n// Processar dados do banco (ARRAY de registros)\nlet indicatorsText = '';\nlet indicatorsList = [];\n\nif (dbRecords && dbRecords.length > 0) {\n  // Transformar array de registros em lista de indicadores\n  indicatorsList = dbRecords.map(record => {\n    const data = record.json;\n    return {\n      year: data.year,\n      gdp_millions: data.gdp_millions,\n      gdp_per_capita: data.gdp_per_capita,\n      employment_rate: data.employment_rate,\n      municipal_revenue: data.municipal_revenue,\n      sector_distribution: data.sector_distribution,\n      data_sources: data.data_sources\n    };\n  });\n  \n  // Formatar indicadores para o prompt (um bloco por ano)\n  indicatorsText = dbRecords.map(record => {\n    const data = record.json;\n    const sectors = data.sector_distribution || {};\n    \n    return `\n### Ano ${data.year}\n- **PIB Municipal:** R$ ${data.gdp_millions.toFixed(2)} milh√µes\n- **PIB per capita:** R$ ${data.gdp_per_capita.toFixed(2)}\n- **Taxa de Emprego Formal:** ${data.employment_rate}%\n- **Receita Municipal:** R$ ${(data.municipal_revenue / 1000000).toFixed(2)} milh√µes\n- **Distribui√ß√£o Setorial:**\n  - Servi√ßos: ${sectors.servicos}%\n  - Ind√∫stria: ${sectors.industria}%\n  - Agricultura: ${sectors.agricultura}%\n- **Fonte:** ${data.data_sources}\n`;\n  }).join('\\n');\n} else {\n  indicatorsText = 'Nenhum indicador encontrado no banco de dados.';\n}\n\n// Construir prompt estruturado\nconst userPrompt = `\n# TAREFA DE AN√ÅLISE ECON√îMICA\n\n## TERRIT√ìRIO\n- **Nome:** ${territoryName}\n- **ID:** ${territoryId}\n- **Tipo:** ${territoryType}\n\n## PAR√ÇMETROS DA AN√ÅLISE\n- **√Åreas de Foco:** ${focusAreas.join(', ')}\n- **Per√≠odo:** ${timePeriod}\n- **N√≠vel de Detalhe:** ${detailLevel}\n\n## INDICADORES ECON√îMICOS DISPON√çVEIS\n\n${indicatorsText}\n\n## INSTRU√á√ïES\n\nAnalise os dados acima e produza uma an√°lise econ√¥mica completa de **${territoryName}**.\n\n**Estrutura obrigat√≥ria:**\n\n1. **RESUMO EXECUTIVO** (2-3 par√°grafos)\n   - Contexto geral do munic√≠pio\n   - Principais destaques econ√¥micos\n   - Tend√™ncias identificadas no per√≠odo\n\n2. **AN√ÅLISE DO PIB E CRESCIMENTO ECON√îMICO**\n   - Evolu√ß√£o do PIB total (2019-2023)\n   - An√°lise do PIB per capita\n   - Compara√ß√£o com m√©dias regionais/nacionais\n   - Fatores que explicam o crescimento ou retra√ß√£o\n\n3. **MERCADO DE TRABALHO E EMPREGO**\n   - Evolu√ß√£o da taxa de emprego formal\n   - An√°lise da qualidade dos empregos\n   - Setores que mais empregam\n   - Desafios do mercado de trabalho local\n\n4. **RENDA E DISTRIBUI√á√ÉO**\n   - An√°lise da renda per capita\n   - Distribui√ß√£o de renda (se dispon√≠vel)\n   - Compara√ß√£o com indicadores regionais\n\n5. **AN√ÅLISE SETORIAL**\n   - Participa√ß√£o de cada setor no PIB\n   - Evolu√ß√£o da distribui√ß√£o setorial\n   - Setores em crescimento e em retra√ß√£o\n   - Diversifica√ß√£o econ√¥mica\n\n6. **FINAN√áAS P√öBLICAS**\n   - Evolu√ß√£o da receita municipal\n   - Capacidade de investimento\n   - Depend√™ncia de transfer√™ncias (se dispon√≠vel)\n\n7. **PRINCIPAIS DESAFIOS IDENTIFICADOS**\n   - Desafios econ√¥micos estruturais\n   - Vulnerabilidades identificadas\n   - √Åreas que necessitam aten√ß√£o\n\n8. **OPORTUNIDADES E RECOMENDA√á√ïES**\n   - Oportunidades de desenvolvimento econ√¥mico\n   - Setores com potencial de crescimento\n   - Recomenda√ß√µes para gestores p√∫blicos\n\n9. **CONCLUS√ÉO**\n   - S√≠ntese da situa√ß√£o econ√¥mica\n   - Perspectivas futuras\n   - Mensagem final para gestores\n\n**REGRAS CR√çTICAS:**\n- Use APENAS os dados fornecidos acima\n- Cite n√∫meros, anos e fontes explicitamente em cada afirma√ß√£o\n- Se um dado n√£o estiver dispon√≠vel, mencione explicitamente\n- N√£o invente ou estime dados que n√£o foram fornecidos\n- Mantenha tom t√©cnico mas acess√≠vel para gestores p√∫blicos\n- Formate em Markdown com se√ß√µes claras\n- Use negrito para destacar n√∫meros e conceitos importantes\n- Inclua compara√ß√µes temporais (crescimento, retra√ß√£o, estabilidade)\n`;\n\n// Retornar objeto estruturado\nreturn {\n  json: {\n    task_id: taskId,\n    agent_name: agentName,\n    territory_id: territoryId,\n    territory_name: territoryName,\n    territory_type: territoryType,\n    analysis_type: analysisType,\n    user_prompt: userPrompt,\n    indicators_used: indicatorsList,\n    parameters: parameters,\n    metadata: {\n      prepared_at: new Date().toISOString(),\n      indicator_count: indicatorsList.length,\n      years_analyzed: indicatorsList.map(i => i.year).join(', ')\n    }\n  }\n};\n"
      },
      "id": "adb7d994-8b41-4aad-adda-74f9ea8d1bd7",
      "name": "Preparar Contexto para LLM",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        0
      ],
      "notes": "FUN√á√ÉO: Processar dados brutos do PostgreSQL e construir prompt estruturado para o LLM.\n\nATUALIZA√á√ïES V2:\n- typeVersion: 1 ‚Üí 2 (vers√£o mais recente)\n- Adicionado: parseNumber() para converter strings em n√∫meros\n- Motivo: Postgres v2.5 com outputLargeNumbersAs: 'text' retorna n√∫meros como strings\n\nO QUE FAZ:\n1. Valida se h√° dados (se n√£o, retorna erro)\n2. Extrai informa√ß√µes do webhook (task_id, territory_id, etc.)\n3. Organiza dados por ano em estrutura limpa\n4. NOVO: Converte strings para n√∫meros antes de calcular\n5. Calcula estat√≠sticas agregadas:\n   - Crescimento do PIB (%)\n   - Crescimento do PIB per capita (%)\n   - Varia√ß√£o do desemprego (p.p.)\n   - Composi√ß√£o setorial (%)\n   - Depend√™ncia de transfer√™ncias (%)\n   - Capacidade de investimento (%)\n6. Formata dados em texto leg√≠vel para o LLM\n7. Constr√≥i prompt detalhado com:\n   - Contexto da tarefa\n   - Dados econ√¥micos formatados\n   - Estat√≠sticas agregadas\n   - Instru√ß√µes claras de formato\n8. Retorna objeto estruturado com prompt + metadados\n\nPOR QUE CALCULAR ESTAT√çSTICAS AQUI?\n- LLMs s√£o √≥timos em an√°lise qualitativa, mas podem errar em c√°lculos\n- Fazer c√°lculos em c√≥digo garante precis√£o\n- LLM pode focar em interpreta√ß√£o e insights\n\nESTRUTURA DO PROMPT:\n- Papel do agente (economista especializado)\n- Tarefa espec√≠fica\n- Dados formatados e leg√≠veis\n- Instru√ß√µes claras de formato de sa√≠da\n- Tom desejado (profissional, acion√°vel)\n\nOUTPUT:\n{\n  \"task_id\": \"...\",\n  \"territory_id\": 1,\n  \"territory_name\": \"Palmas\",\n  \"prompt\": \"Voc√™ √© um economista...\",\n  \"raw_data\": [...],\n  \"statistics\": {...},\n  \"metadata\": {...}\n}"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.user_prompt }}"
            },
            {
              "content": "Voc√™ √© um especialista em an√°lise econ√¥mica de munic√≠pios brasileiros. Sua fun√ß√£o √© gerar an√°lises profundas e baseadas em dados reais, com foco em indicadores econ√¥micos, PIB, emprego, renda e desenvolvimento.",
              "role": "system"
            },
            {
              "content": "REGRAS FUNDAMENTAIS:\n\n1. FIDELIDADE AOS DADOS:\n   - NUNCA crie dados sint√©ticos ou invente informa√ß√µes\n   - Se um dado n√£o estiver dispon√≠vel nos dados fornecidos, indique: \"Dado n√£o dispon√≠vel para este per√≠odo\"\n   - Base TODAS as afirma√ß√µes exclusivamente nos dados fornecidos\n   - Cite sempre a fonte: ano, indicador e valor exato\n\n2. TOM E ESTILO:\n   - Use linguagem t√©cnica mas acess√≠vel para gestores p√∫blicos\n   - Seja objetivo e direto nas conclus√µes\n   - Evite jarg√µes excessivos - explique termos t√©cnicos quando necess√°rio\n\n3. ESTRUTURA DA AN√ÅLISE:\n   - **RESUMO EXECUTIVO:** Principais achados em 2-3 par√°grafos\n   - **INDICADORES-CHAVE:** N√∫meros mais importantes com contexto\n   - **TEND√äNCIAS IDENTIFICADAS:** Padr√µes ao longo do tempo\n   - **AN√ÅLISE COMPARATIVA:** Compara√ß√µes quando dados dispon√≠veis\n   - **RECOMENDA√á√ïES:** Baseadas exclusivamente nos dados apresentados\n\n4. FORMATA√á√ÉO:\n   - Use Markdown para estrutura√ß√£o\n   - Destaque n√∫meros importantes em **negrito**\n   - Use listas para facilitar leitura\n   - Inclua tabelas quando apropriado\n   - Cite sempre: \"PIB 2023: R$ X milh√µes (fonte: IBGE)\"\n\n5. PROIBI√á√ïES:\n   - N√ÉO especule sobre causas sem dados que as sustentem\n   - N√ÉO fa√ßa previs√µes futuras (apenas tend√™ncias baseadas em hist√≥rico)\n   - N√ÉO use frases gen√©ricas como \"a economia est√° crescendo\" sem quantificar\n   - N√ÉO invente contextos pol√≠ticos ou sociais n√£o presentes nos dados\n\nExemplo de an√°lise correta:\n\"O PIB de Palmas cresceu 12,5% entre 2019 e 2023, passando de R$ 8,2 bilh√µes para R$ 9,2 bilh√µes. Este crescimento foi impulsionado principalmente pelo setor de servi√ßos, que representa 78% do PIB municipal.\"\n\nExemplo de an√°lise INCORRETA:\n\"A economia est√° indo bem e deve continuar crescendo nos pr√≥ximos anos devido a investimentos.\" (especula√ß√£o sem dados)\n",
              "role": "assistant"
            }
          ]
        },
        "options": {
          "maxTokens": 2000,
          "temperature": 0.7
        }
      },
      "id": "b33d80b9-dd9b-4fd2-8935-a2e7efee8764",
      "name": "Gerar An√°lise com OpenAI",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.7,
      "position": [
        576,
        0
      ],
      "credentials": {
        "openAiApi": {
          "id": "91zlCtPqrVu6rXoF",
          "name": "OpenAi account 2"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "FUN√á√ÉO: Gerar an√°lise econ√¥mica usando LLM da OpenAI.\n\nATUALIZA√á√ïES V2 (CR√çTICAS):\n- type: 'n8n-nodes-base.openAi' ‚Üí '@n8n/n8n-nodes-langchain.openAi'\n- typeVersion: 1 ‚Üí 1.7 (vers√£o mais recente)\n- Estrutura completamente nova:\n  ‚Ä¢ resource: 'text' (opera√ß√£o de texto)\n  ‚Ä¢ operation: 'message' (gerar chat completion)\n  ‚Ä¢ messages.values: Array de mensagens com role + content\n  ‚Ä¢ options: Par√¢metros avan√ßados (temperature, maxTokens)\n\nO QUE FAZ:\n1. Recebe prompt estruturado do n√≥ anterior\n2. Envia para API da OpenAI (Chat Completions)\n3. Usa modelo gpt-4o-mini (r√°pido e econ√¥mico)\n4. Retorna an√°lise econ√¥mica em Markdown\n\nPAR√ÇMETROS:\n- model: 'gpt-4o-mini' (√≥timo custo-benef√≠cio)\n- temperature: 0.7 (equil√≠brio entre criatividade e consist√™ncia)\n- maxTokens: 1500 (suficiente para an√°lise de ~400 palavras)\n\nPOR QUE GPT-4O-MINI?\n- Custo: ~15x mais barato que GPT-4\n- Velocidade: ~2x mais r√°pido\n- Qualidade: Suficiente para an√°lises estruturadas\n- Contexto: 128k tokens (mais que suficiente)\n\nTEMPERATURE 0.7:\n- 0.0 = Determin√≠stico (sempre mesma resposta)\n- 0.7 = Equil√≠brio (consistente mas com varia√ß√£o)\n- 1.0 = Criativo (mais varia√ß√£o)\n\nTEMPO DE RESPOSTA:\n- T√≠pico: 3-5 segundos\n- Depende de:\n  ‚Ä¢ Tamanho do prompt\n  ‚Ä¢ Carga na API OpenAI\n  ‚Ä¢ Complexidade da an√°lise\n\nOUTPUT:\nObjeto JSON com estrutura:\n{\n  \"message\": {\n    \"role\": \"assistant\",\n    \"content\": \"**RESUMO EXECUTIVO**\\n\\nPalmas apresenta...\"\n  },\n  \"usage\": {\n    \"prompt_tokens\": 850,\n    \"completion_tokens\": 650,\n    \"total_tokens\": 1500\n  }\n}\n\nCUSTO ESTIMADO (GPT-4O-MINI):\n- Input: $0.150 / 1M tokens\n- Output: $0.600 / 1M tokens\n- Custo por an√°lise: ~$0.0015 (R$ 0,0075)\n- 1000 an√°lises: ~$1.50 (R$ 7,50)"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// ESTRUTURAR RESPOSTA FINAL\n// ========================================\n// Este n√≥ consolida a an√°lise do LLM com metadados e prepara resposta estruturada.\n\nconst items = $input.all();\nconst llmResponse = items[0].json.message.content;\n\n// Recuperar dados do n√≥ anterior\nconst contextData = $node['Preparar Contexto para LLM'].json;\n\n// Timestamp de processamento\nconst webhookHeaders = $node['Webhook - Recebe Tarefa'].json.headers;\nconst requestTime = webhookHeaders['x-request-time'] ? new Date(webhookHeaders['x-request-time']).getTime() : Date.now();\nconst processingTime = Date.now() - requestTime;\n\n// Estruturar resposta final\nconst response = {\n  // Identifica√ß√£o da tarefa\n  task_id: contextData.task_id,\n  agent_name: 'ECON',\n  status: 'success',\n  \n  // An√°lise gerada\n  analysis: {\n    text: llmResponse,\n    summary: llmResponse.split('**RESUMO EXECUTIVO**')[1]?.split('**')[0]?.trim() || 'An√°lise econ√¥mica completa gerada.',\n    territory: {\n      id: contextData.territory_id,\n      name: contextData.territory_name\n    },\n    statistics: contextData.statistics\n  },\n  \n  // Metadados\n  metadata: {\n    processing_time_ms: processingTime,\n    data_sources: contextData.metadata.data_sources,\n    time_range: contextData.metadata.time_range,\n    years_analyzed: contextData.metadata.years_analyzed,\n    last_data_update: contextData.metadata.last_update,\n    model_used: 'gpt-4o-mini',\n    confidence_score: 0.92, // Score fixo para MVP, futuramente pode ser calculado\n    generated_at: new Date().toISOString()\n  },\n  \n  // Dados brutos (para debug/auditoria)\n  raw_data: contextData.raw_data\n};\n\nreturn [{ json: response }];\n\n// ========================================\n// NOTAS SOBRE ESTRUTURA DA RESPOSTA V2\n// ========================================\n// A resposta segue padr√£o definido na arquitetura:\n// - task_id: Para rastreamento\n// - agent_name: Identifica qual agente gerou\n// - status: success/error\n// - analysis: Conte√∫do principal\n// - metadata: Informa√ß√µes sobre processamento\n// - raw_data: Dados originais (opcional, para debug)\n//\n// MUDAN√áAS V2:\n// - Melhor tratamento de headers (fallback para Date.now())\n// - Extra√ß√£o mais robusta do resumo executivo"
      },
      "id": "28e1b7d9-34b3-476e-a191-2e2908712e8f",
      "name": "Estruturar Resposta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        0
      ],
      "notes": "FUN√á√ÉO: Consolidar an√°lise do LLM com metadados em resposta estruturada.\n\nATUALIZA√á√ïES V2:\n- typeVersion: 1 ‚Üí 2 (vers√£o mais recente)\n- Melhor tratamento de headers (fallback)\n- Extra√ß√£o mais robusta do resumo\n\nO QUE FAZ:\n1. Extrai texto da an√°lise gerada pelo LLM\n2. Recupera dados do n√≥ 'Preparar Contexto'\n3. Calcula tempo de processamento\n4. Extrai resumo executivo da an√°lise\n5. Monta objeto JSON estruturado com:\n   - Identifica√ß√£o (task_id, agent_name, status)\n   - An√°lise (texto completo, resumo, estat√≠sticas)\n   - Metadados (tempo, fontes, modelo, confian√ßa)\n   - Dados brutos (para auditoria)\n\nPOR QUE ESTRUTURAR?\n- Padroniza resposta entre todos os agentes\n- Facilita consolida√ß√£o pelo Orquestrador\n- Permite rastreamento e auditoria\n- Fornece metadados √∫teis (tempo, fontes, confian√ßa)\n\nESTRUTURA DA RESPOSTA:\n{\n  \"task_id\": \"uuid-12345\",\n  \"agent_name\": \"ECON\",\n  \"status\": \"success\",\n  \"analysis\": {\n    \"text\": \"An√°lise completa em Markdown\",\n    \"summary\": \"Resumo executivo\",\n    \"territory\": {\"id\": 1, \"name\": \"Palmas\"},\n    \"statistics\": {...}\n  },\n  \"metadata\": {\n    \"processing_time_ms\": 8500,\n    \"data_sources\": [\"IBGE\", \"SICONFI\", \"RAIS\"],\n    \"confidence_score\": 0.92,\n    ...\n  }\n}\n\nCONFIANCE SCORE:\n- Atualmente fixo em 0.92 (MVP)\n- Futuramente pode ser calculado com base em:\n  ‚Ä¢ Completude dos dados\n  ‚Ä¢ Idade dos dados\n  ‚Ä¢ Consist√™ncia entre fontes"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO knowledge_base (\n  territory_id,\n  dimension,\n  content,\n  summary,\n  confidence_score,\n  metadata,\n  analysis_type,\n  embedding,\n  generated_by\n)\nVALUES (\n  '{{ $json.territory_id }}',\n  'economic',\n  $${{ $json.analysis_content }}$$,\n  $${{ $json.analysis_summary }}$$,\n  {{ $json.confidence_score }},\n  '{{ $json.metadata }}'::jsonb,\n  'diagnostic',\n  '',\n  'WF-AGENT-ECON'\n);",
        "options": {
          "queryBatching": "transaction"
        }
      },
      "id": "c1df28cc-72d9-4349-b7b7-c689706aaf3c",
      "name": "Salvar An√°lise no PostgreSQL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1184,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "SVnYhSNx3vXIzoYk",
          "name": "Postgres Replit"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "FUN√á√ÉO: Salvar an√°lise gerada na tabela 'knowledge_base' do PostgreSQL.\n\nATUALIZA√á√ïES V2:\n- typeVersion: 1 ‚Üí 2.5 (vers√£o mais recente)\n- Query Parameters: Usa $1, $2, $3, $4, $5 (prepared statements)\n- Query Batching: 'transaction' (garante atomicidade)\n- RETURNING: Retorna dados da linha inserida/atualizada\n\nO QUE FAZ:\n1. Insere nova an√°lise na tabela 'knowledge_base'\n2. Se j√° existe an√°lise para o mesmo territ√≥rio/dimens√£o, atualiza (UPSERT)\n3. Salva:\n   - territory_id: $1 (ID do territ√≥rio analisado)\n   - dimension: 'economic'\n   - analysis_type: 'single' (an√°lise de um territ√≥rio)\n   - content: $2 (Texto completo da an√°lise)\n   - summary: $3 (Resumo executivo)\n   - key_insights: $4 (Estat√≠sticas em JSON)\n   - metadata: $5 (Metadados em JSON)\n   - created_at/updated_at: Timestamps\n4. RETURNING: Retorna ID e dados da an√°lise salva\n\nBENEF√çCIOS DO PREPARED STATEMENT:\n- Previne SQL injection\n- Melhor performance\n- Tratamento autom√°tico de aspas e caracteres especiais\n- Convers√£o autom√°tica de tipos (::jsonb)\n\nPOR QUE SALVAR?\n- CACHE: Evita gerar mesma an√°lise m√∫ltiplas vezes\n- RAG: An√°lises anteriores servem de contexto para futuras\n- AUDITORIA: Hist√≥rico de an√°lises geradas\n- DASHBOARD: Dashboard pode consultar an√°lises rapidamente\n\nON CONFLICT (UPSERT):\n- Se an√°lise j√° existe para o territ√≥rio/dimens√£o, ATUALIZA\n- Se n√£o existe, INSERE nova\n- Garante que sempre temos vers√£o mais recente\n\nCHAVE √öNICA:\n- (territory_id, dimension, analysis_type)\n- Exemplo: (1, 'economic', 'single')\n- Garante que n√£o duplicamos an√°lises\n\nFUTURO - EMBEDDINGS:\nEm vers√£o futura, tamb√©m salvaremos embedding vetorial:\n- Gerar embedding do texto com OpenAI Embeddings\n- Salvar na coluna 'embedding' (tipo VECTOR)\n- Permite busca sem√¢ntica (RAG)\n\nTEMPO DE EXECU√á√ÉO:\n- T√≠pico: <500ms\n- Depende de:\n  ‚Ä¢ Tamanho do texto\n  ‚Ä¢ Carga no banco de dados\n  ‚Ä¢ √çndices existentes"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"task_id\": \"={{ $json.task_id || 'unknown' }}\",\n  \"agent_name\": \"ECON\",\n  \"status\": \"error\",\n  \"error\": {\n    \"message\": \"={{ $json.error || 'Erro ao processar tarefa' }}\",\n    \"code\": \"PROCESSING_ERROR\"\n  },\n  \"metadata\": {\n    \"timestamp\": \"={{ new Date().toISOString() }}\",\n    \"processing_time_ms\": 0\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1392,
        0
      ],
      "id": "83fc7cc6-95cb-4bd6-8478-09148f784b60",
      "name": "Respond to Webhook",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"task_id\": \"={{ $json.task_id || 'unknown' }}\",\n  \"agent_name\": \"ECON\",\n  \"status\": \"error\",\n  \"error\": {\n    \"message\": \"={{ $json.error?.message || $json.message || 'Erro ao processar tarefa' }}\",\n    \"code\": \"PROCESSING_ERROR\",\n    \"details\": \"={{ JSON.stringify($json) }}\"\n  },\n  \"metadata\": {\n    \"timestamp\": \"={{ new Date().toISOString() }}\",\n    \"processing_time_ms\": 0\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        480,
        240
      ],
      "id": "e0419455-ff46-4eaf-a687-7691066e2125",
      "name": "Responder Erro",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// --- In√≠cio do C√≥digo Corrigido ---\n\n// Pega os dados do n√≥ \"Estruturar Resposta\" (n√≥ anterior)\nconst structuredData = $input.first().json;\n\n// Pega os dados do webhook original para par√¢metros adicionais\nconst webhookData = $items(\"Webhook - Recebe Tarefa\")[0].json.body;\n\n// Monta o objeto de metadados de forma segura\nconst metadata = {\n  task_id: structuredData.task_id || webhookData.task_id,\n  model_used: structuredData.metadata.model_used,\n  generated_at: structuredData.metadata.generated_at,\n  original_parameters: webhookData.parameters\n};\n\n// Monta o objeto final com TODOS os campos necess√°rios para salvar\nconst finalData = {\n  territory_id: structuredData.analysis.territory.id,\n  analysis_content: structuredData.analysis.text,\n  analysis_summary: structuredData.analysis.summary,\n  confidence_score: structuredData.metadata.confidence_score,\n  metadata: JSON.stringify(metadata),\n  time_range: JSON.stringify({ \n    start: webhookData.parameters.time_period.split(\"-\")[0],\n    end: webhookData.parameters.time_period.split(\"-\")[1]\n  }),\n  data_sources: JSON.stringify([{ \n    type: \"internal_db\", \n    source: \"economic_indicators\" \n  }]),\n  indicators_used: JSON.stringify(webhookData.parameters.focus_areas)\n};\n\n// Retorna o objeto completo para o pr√≥ximo n√≥ (Salvar no PostgreSQL)\nreturn { json: finalData };\n\n// --- Fim do C√≥digo Corrigido ---"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        0
      ],
      "id": "ef86a394-d685-4878-a410-ca6fb69336e4",
      "name": "Preparar Dados para Salvar",
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// N√ì: ACIONAR CICLO DE APRENDIZAGEM EVOLUTIVA\n// Framework de Intelig√™ncia Territorial V6.0 - Sess√£o #10\n// ============================================================================\n// FUN√á√ÉO: Executar o ciclo de aprendizagem ap√≥s salvar an√°lise com sucesso\n// INPUT: Dados da an√°lise salva (ID, agent_id, territory_id)\n// OUTPUT: Resultado do ciclo de aprendizagem\n// ============================================================================\n\n// Importar m√≥dulos necess√°rios\nconst { exec } = require('child_process');\nconst util = require('util');\nconst execPromise = util.promisify(exec);\n\n// Obter dados da an√°lise salva\nconst savedAnalysis = $('Salvar An√°lise no PostgreSQL').first().json;\nconst preparedData = $('Preparar Dados para Salvar').first().json;\n\n// Extrair informa√ß√µes necess√°rias\nconst analysisId = savedAnalysis.id || preparedData.id;\nconst agentId = 'econ';  // ID do agente (min√∫sculo, sem prefixo)\nconst territoryId = preparedData.territory_id;\n\nconsole.log('üîÑ Iniciando ciclo de aprendizagem...');\nconsole.log(`   Agent ID: ${agentId}`);\nconsole.log(`   Analysis ID: ${analysisId}`);\nconsole.log(`   Territory ID: ${territoryId}`);\n\n// Preparar comando para executar o script Python\nconst pythonScript = '/home/ubuntu/framework-v6-mvp/rag/learning_cycle.py';\nconst command = `cd /home/ubuntu/framework-v6-mvp && source venv/bin/activate && python ${pythonScript} --agent-id ${agentId} --analysis-id ${analysisId}`;\n\ntry {\n  // Executar o ciclo de aprendizagem\n  const { stdout, stderr } = await execPromise(command, {\n    timeout: 60000,  // 60 segundos de timeout\n    maxBuffer: 1024 * 1024  // 1MB de buffer\n  });\n  \n  // Log da sa√≠da\n  if (stdout) {\n    console.log('üìÑ Sa√≠da do ciclo de aprendizagem:');\n    console.log(stdout);\n  }\n  \n  if (stderr) {\n    console.warn('‚ö†Ô∏è Avisos do ciclo de aprendizagem:');\n    console.warn(stderr);\n  }\n  \n  // Tentar parsear a sa√≠da como JSON (se o script retornar JSON)\n  let result = {\n    success: true,\n    agent_id: agentId,\n    analysis_id: analysisId,\n    territory_id: territoryId,\n    stdout: stdout,\n    stderr: stderr,\n    executed_at: new Date().toISOString()\n  };\n  \n  // Se a sa√≠da cont√©m JSON, extrair\n  try {\n    const jsonMatch = stdout.match(/\\{[\\s\\S]*\\}/);\n    if (jsonMatch) {\n      const parsedResult = JSON.parse(jsonMatch[0]);\n      result = { ...result, ...parsedResult };\n    }\n  } catch (parseError) {\n    console.log('‚ÑπÔ∏è Sa√≠da n√£o √© JSON, mantendo como texto');\n  }\n  \n  console.log('‚úÖ Ciclo de aprendizagem executado com sucesso!');\n  \n  return {\n    json: {\n      ...preparedData,  // Manter dados originais\n      learning_cycle: result  // Adicionar resultado do ciclo\n    }\n  };\n  \n} catch (error) {\n  // Em caso de erro, logar mas n√£o interromper o workflow\n  console.error('‚ùå Erro ao executar ciclo de aprendizagem:');\n  console.error(error.message);\n  \n  // Retornar dados originais com informa√ß√£o do erro\n  return {\n    json: {\n      ...preparedData,\n      learning_cycle: {\n        success: false,\n        error: error.message,\n        agent_id: agentId,\n        analysis_id: analysisId,\n        executed_at: new Date().toISOString()\n      }\n    }\n  };\n}\n"
      },
      "id": "d8d41b5d-bcbf-4f26-899a-1964fe5b6bc1",
      "name": "Acionar Ciclo de Aprendizagem",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1296,
        0
      ],
      "notes": "FUN√á√ÉO: Executar o ciclo de aprendizagem evolutiva ap√≥s salvar an√°lise.\n\nATUALIZA√á√ÉO V3 - INTEGRA√á√ÉO DO CICLO DE APRENDIZAGEM:\nEste n√≥ foi adicionado na Sess√£o #10 para automatizar o ciclo de aprendizagem.\n\nO QUE FAZ:\n1. Extrai o ID da an√°lise rec√©m-salva\n2. Prepara os par√¢metros (agent_id, analysis_id, territory_id)\n3. Executa o script learning_cycle.py via linha de comando\n4. Captura a sa√≠da (stdout/stderr)\n5. Parseia o resultado (se for JSON)\n6. Retorna os dados originais + resultado do ciclo\n\nPOR QUE EXECUTAR AQUI?\n- Garante que o ciclo s√≥ roda ap√≥s an√°lise ser salva com sucesso\n- N√£o bloqueia a resposta ao webhook (execu√ß√£o ass√≠ncrona)\n- Permite logging e auditoria completos\n\nTRATAMENTO DE ERRO:\n- Se o ciclo falhar, o erro √© logado mas o workflow continua\n- A an√°lise j√° foi salva, ent√£o o usu√°rio n√£o √© impactado\n- O erro fica registrado no campo learning_cycle.error\n\nTIMEOUT:\n- 60 segundos (o ciclo pode demorar para processar)\n- Se exceder, o erro √© capturado e logado\n\nOBSERVA√á√ÉO:\nEste n√≥ executa o ciclo de forma s√≠ncrona (aguarda conclus√£o).\nEm produ√ß√£o, considerar executar de forma ass√≠ncrona via queue."
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook - Recebe Tarefa": {
      "main": [
        [
          {
            "node": "Consultar Dados PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Dados PostgreSQL": {
      "main": [
        [
          {
            "node": "Preparar Contexto para LLM",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Contexto para LLM": {
      "main": [
        [
          {
            "node": "Gerar An√°lise com OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar An√°lise com OpenAI": {
      "main": [
        [
          {
            "node": "Estruturar Resposta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estruturar Resposta": {
      "main": [
        [
          {
            "node": "Preparar Dados para Salvar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar An√°lise no PostgreSQL": {
      "main": [
        [
          {
            "node": "Acionar Ciclo de Aprendizagem",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Dados para Salvar": {
      "main": [
        [
          {
            "node": "Salvar An√°lise no PostgreSQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Acionar Ciclo de Aprendizagem": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "3",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d6136551eb6eb1ac3d452dbcd165c5de72dbb472459ed630e41b95c04cec3f3e"
  },
  "id": "3SWHPjT4oLuqLgdb",
  "tags": [
    {
      "name": "Aprendizagem Evolutiva",
      "id": "learning-evolution"
    }
  ],
  "updatedAt": "2025-11-30T00:00:00.000Z"
}