{
  "name": "WF-AGENT-ECON - Especialista EconÃ´mico V6.1 (Multidimensional)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "agent-econ",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "de732c22-107b-4fc6-a796-8d273316bb6a",
      "name": "Webhook - Recebe Tarefa",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -32,
        0
      ],
      "webhookId": "agent-econ-webhook",
      "notes": "FUNÃ‡ÃƒO: Ponto de entrada do Agente ECON.\n\nATUALIZAÃ‡Ã•ES V2:\n- typeVersion: 1 â†’ 2 (versÃ£o mais recente)\n- Adicionado: ignoreBots: true (ignora bots e crawlers)\n- Mantido: CORS permitido (*) para testes\n\nRECEBE: RequisiÃ§Ã£o HTTP POST do Orquestrador com:\n- task_id: ID Ãºnico da tarefa\n- territory_id: ID do territÃ³rio a analisar\n- territory_name: Nome do territÃ³rio\n- dimension: 'economic'\n- task_description: DescriÃ§Ã£o da anÃ¡lise solicitada\n- context: Contexto adicional (comparaÃ§Ãµes, perÃ­odo, etc.)\n\nEXEMPLO DE PAYLOAD:\n{\n  \"task_id\": \"uuid-12345\",\n  \"territory_id\": 1,\n  \"territory_name\": \"Palmas\",\n  \"dimension\": \"economic\",\n  \"task_description\": \"Analisar evoluÃ§Ã£o econÃ´mica de Palmas (2019-2023)\",\n  \"context\": {\n    \"user_question\": \"Como estÃ¡ a economia de Palmas?\",\n    \"comparison_territories\": [],\n    \"time_range\": \"2019-2023\"\n  }\n}\n\nCONFIGURAÃ‡Ã•ES:\n- MÃ©todo: POST (para receber dados)\n- Path: /agent-econ (URL serÃ¡ https://galactic-ai.app.n8n.cloud/webhook/agent-econ)\n- Response Mode: responseNode (resposta serÃ¡ enviada por nÃ³ especÃ­fico)\n- CORS: Permitido de qualquer origem (para testes)\n- Ignore Bots: true (reduz ruÃ­do de crawlers)"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// NÃ“: NORMALIZAR ENTRADA\n// Framework de InteligÃªncia Territorial V6.0 - Workflow V5\n// ============================================================================\n// FUNÃ‡ÃƒO: Validar e normalizar o payload recebido do webhook\n// INPUT: Webhook (body)\n// OUTPUT: Objeto normalizado com valores padrÃ£o para campos opcionais\n// ============================================================================\n\n// Receber dados do webhook\nconst webhookData = $input.first().json.body || {};\n\n// ============================================================================\n// VALIDAÃ‡ÃƒO DE CAMPOS OBRIGATÃ“RIOS\n// ============================================================================\n\nconst requiredFields = ['agent_id', 'territory_id', 'analysis_type'];\nconst missingFields = [];\n\nfor (const field of requiredFields) {\n  if (!webhookData[field]) {\n    missingFields.push(field);\n  }\n}\n\n// Se houver campos obrigatÃ³rios faltando, retornar erro\nif (missingFields.length > 0) {\n  throw new Error(`Campos obrigatÃ³rios ausentes: ${missingFields.join(', ')}`);\n}\n\n// ============================================================================\n// NORMALIZAÃ‡ÃƒO DE CAMPOS OPCIONAIS\n// ============================================================================\n\n// Campos simples com valores padrÃ£o\nconst territory_name = webhookData.territory_name || \"TerritÃ³rio Desconhecido\";\nconst user_id = webhookData.user_id || \"system\";\n\n// Objeto parameters com valores padrÃ£o\nconst parameters = webhookData.parameters || {};\nconst time_period = parameters.time_period || \"2019-2023\";\nconst focus_areas = parameters.focus_areas || [\"PIB\", \"emprego\", \"renda\"];\nconst detail_level = parameters.detail_level || \"comprehensive\";\n\n// ============================================================================\n// MONTAGEM DO OBJETO NORMALIZADO\n// ============================================================================\n\nconst normalizedData = {\n  // Campos obrigatÃ³rios (jÃ¡ validados)\n  agent_id: webhookData.agent_id,\n  territory_id: webhookData.territory_id,\n  analysis_type: webhookData.analysis_type,\n  \n  // Campos opcionais (com valores padrÃ£o)\n  territory_name: territory_name,\n  user_id: user_id,\n  \n  // Objeto parameters normalizado\n  parameters: {\n    time_period: time_period,\n    focus_areas: focus_areas,\n    detail_level: detail_level\n  },\n  \n  // Metadados de normalizaÃ§Ã£o\n  _normalized: {\n    timestamp: new Date().toISOString(),\n    fields_added: [],\n    original_payload: webhookData\n  }\n};\n\n// Registrar quais campos foram adicionados\nif (!webhookData.territory_name) normalizedData._normalized.fields_added.push('territory_name');\nif (!webhookData.user_id) normalizedData._normalized.fields_added.push('user_id');\nif (!webhookData.parameters) normalizedData._normalized.fields_added.push('parameters');\nif (!parameters.time_period) normalizedData._normalized.fields_added.push('parameters.time_period');\nif (!parameters.focus_areas) normalizedData._normalized.fields_added.push('parameters.focus_areas');\nif (!parameters.detail_level) normalizedData._normalized.fields_added.push('parameters.detail_level');\n\n// ============================================================================\n// RETORNO\n// ============================================================================\n\nreturn {\n  json: normalizedData\n};\n"
      },
      "id": "normalizar-entrada-v5",
      "name": "Normalizar Entrada",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        0
      ],
      "notes": "FUNÃ‡ÃƒO: Validar e normalizar o payload recebido do webhook.\n\nO QUE FAZ:\n1. Valida campos obrigatÃ³rios (agent_id, territory_id, analysis_type)\n2. Adiciona valores padrÃ£o para campos opcionais\n3. Normaliza o objeto parameters\n4. Registra quais campos foram adicionados\n\nBENEFÃCIOS:\n- Garante que todos os nÃ³s seguintes recebam dados consistentes\n- Elimina erros de 'undefined' em nÃ³s posteriores\n- Centraliza a lÃ³gica de validaÃ§Ã£o\n- Facilita debugging (registra campos adicionados)"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ============================================================================\n-- NÃ“: CONSULTAR MEMÃ“RIA E APRENDIZADOS\n-- Framework de InteligÃªncia Territorial V6.0 - Workflow V6\n-- ============================================================================\n-- FUNÃ‡ÃƒO: Consultar as 4 Camadas do RAG Evolutivo\n-- INPUT: territory_id do webhook normalizado\n-- OUTPUT: AnÃ¡lises anteriores, aprendizados, expertise atual\n-- ============================================================================\n\n-- CAMADA 1: MEMÃ“RIA ESPECIALIZADA (AnÃ¡lises Anteriores)\n-- Busca as Ãºltimas 5 anÃ¡lises NÃƒO ARQUIVADAS do mesmo territÃ³rio\nSELECT \n  'memory' AS source_layer,\n  id AS memory_id,\n  analysis_content,\n  analysis_summary,\n  confidence_score,\n  created_at,\n  metadata,\n  time_range,\n  indicators_used\nFROM agent_econ_memory\nWHERE territory_id = '{{ $('Normalizar Entrada').first().json.territory_id }}'\n  AND archived_at IS NULL\nORDER BY created_at DESC\nLIMIT 5\n\nUNION ALL\n\n-- CAMADA 2: APRENDIZADO EVOLUTIVO (SÃ­nteses e PadrÃµes)\n-- Busca os Ãºltimos 10 aprendizados do agente ECON\nSELECT \n  'learning' AS source_layer,\n  id AS learning_id,\n  synthesis AS analysis_content,\n  'Aprendizado acumulado' AS analysis_summary,\n  confidence_score,\n  created_at,\n  NULL AS metadata,\n  NULL AS time_range,\n  NULL AS indicators_used\nFROM agent_econ_learning_evolution\nWHERE agent_id = 'econ'\nORDER BY created_at DESC\nLIMIT 10\n\nUNION ALL\n\n-- CAMADA 4: EXPERTISE DINÃ‚MICA (NÃ­vel Atual)\n-- Busca o nÃ­vel de expertise atual do agente\nSELECT \n  'expertise' AS source_layer,\n  NULL AS memory_id,\n  expertise_level AS analysis_content,\n  CAST(analysis_count AS TEXT) || ' anÃ¡lises realizadas' AS analysis_summary,\n  avg_confidence AS confidence_score,\n  last_analysis_date AS created_at,\n  NULL AS metadata,\n  NULL AS time_range,\n  NULL AS indicators_used\nFROM get_agent_expertise('econ')\n\nORDER BY created_at DESC;\n",
        "options": {}
      },
      "id": "consultar-memoria-v6",
      "name": "Consultar MemÃ³ria e Aprendizados",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [
        300,
        -100
      ],
      "credentials": {
        "postgres": {
          "id": "postgres-neon",
          "name": "Postgres Neon"
        }
      },
      "notes": "FUNÃ‡ÃƒO: Consultar as 4 Camadas do RAG Evolutivo.\n\nCAMADAS CONSULTADAS:\n- Camada 1: MemÃ³ria Especializada (Ãºltimas 5 anÃ¡lises do territÃ³rio)\n- Camada 2: Aprendizado Evolutivo (Ãºltimos 10 aprendizados do agente)\n- Camada 4: Expertise DinÃ¢mica (nÃ­vel atual de expertise)\n\nIMPORTÃ‚NCIA:\n- Permite que o agente APRENDA de suas anÃ¡lises anteriores\n- Evita repetir conclusÃµes jÃ¡ feitas\n- Aprofunda insights superficiais\n- Identifica mudanÃ§as ao longo do tempo\n\nSEM ESTE NÃ“, O AGENTE NÃƒO EVOLUI!"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- ========================================\n-- QUERY MULTIDIMENSIONAL PARA ANÃLISE ECONÃ”MICA\n-- VersÃ£o: 1.0\n-- Data: 30/11/2025\n-- DescriÃ§Ã£o: Consulta dados econÃ´micos, sociais, territoriais e ambientais\n--            para enriquecer anÃ¡lise econÃ´mica com contexto multidimensional\n-- ========================================\n\n-- ParÃ¢metro de entrada (substituÃ­do pelo n8n):\n-- {{ $('Normalizar Entrada').first().json.territory_id }}\n\nWITH \n-- 1. DADOS TERRITORIAIS (Base geogrÃ¡fica e infraestrutura)\nterritory_data AS (\n  SELECT \n    t.id AS territory_id,\n    t.name AS territory_name,\n    t.type AS territory_type,\n    t.area AS territory_area_km2,\n    t.population AS population,\n    t.geometry,\n    ti.year AS territorial_year,\n    ti.urban_area_km2,\n    ti.rural_area_km2,\n    ti.road_network_km,\n    ti.paved_roads_km,\n    ti.unpaved_roads_km,\n    ti.distance_to_capital_km,\n    ti.distance_to_nearest_port_km,\n    ti.has_airport,\n    ti.has_railway,\n    ti.has_waterway,\n    ti.internet_coverage_pct,\n    ti.mobile_coverage_pct,\n    ti.electricity_coverage_pct\n  FROM territories t\n  LEFT JOIN territorial_indicators ti ON t.id = ti.territory_id\n  WHERE t.id = '{{ $('Normalizar Entrada').first().json.territory_id }}'\n    AND (ti.year IS NULL OR ti.year >= 2019)\n),\n\n-- 2. DADOS ECONÃ”MICOS (Indicadores econÃ´micos principais)\neconomic_data AS (\n  SELECT \n    ei.territory_id,\n    ei.year AS economic_year,\n    ei.gdp AS gdp_millions,\n    ei.gdp_per_capita,\n    ei.employment_rate,\n    ei.formal_employment_count,\n    ei.informal_employment_est_pct,\n    ei.average_salary,\n    ei.revenue AS municipal_revenue,\n    ei.own_revenue,\n    ei.transfer_revenue,\n    ei.fiscal_dependency_pct,\n    ei.sector_distribution,\n    ei.agriculture_gdp_pct,\n    ei.industry_gdp_pct,\n    ei.services_gdp_pct,\n    ei.public_admin_gdp_pct,\n    ei.exports_usd,\n    ei.imports_usd,\n    ei.trade_balance_usd,\n    ei.credit_volume_millions,\n    ei.business_count,\n    ei.micro_business_pct,\n    ei.small_business_pct,\n    ei.medium_business_pct,\n    ei.large_business_pct\n  FROM economic_indicators ei\n  WHERE ei.territory_id = '{{ $('Normalizar Entrada').first().json.territory_id }}'\n    AND ei.year >= 2019\n    AND ei.year <= 2023\n),\n\n-- 3. DADOS SOCIAIS (EducaÃ§Ã£o, saÃºde, pobreza - impactam economia)\nsocial_data AS (\n  SELECT \n    si.territory_id,\n    si.year AS social_year,\n    si.ideb_initial_years,\n    si.ideb_final_years,\n    si.illiteracy_rate_pct,\n    si.higher_education_pct,\n    si.poverty_rate_pct,\n    si.extreme_poverty_rate_pct,\n    si.gini_index,\n    si.unemployment_rate_pct,\n    si.informal_work_pct,\n    si.child_mortality_per_1000,\n    si.life_expectancy_years,\n    si.basic_sanitation_coverage_pct,\n    si.treated_water_coverage_pct,\n    si.sewage_coverage_pct,\n    si.solid_waste_collection_pct,\n    si.bolsa_familia_families,\n    si.bolsa_familia_coverage_pct\n  FROM social_indicators si\n  WHERE si.territory_id = '{{ $('Normalizar Entrada').first().json.territory_id }}'\n    AND si.year >= 2019\n    AND si.year <= 2023\n),\n\n-- 4. DADOS AMBIENTAIS (Uso do solo, desmatamento - afetam agropecuÃ¡ria)\nenvironmental_data AS (\n  SELECT \n    ei.territory_id,\n    ei.year AS environmental_year,\n    ei.forest_cover_km2,\n    ei.forest_cover_pct,\n    ei.deforestation_km2_year,\n    ei.deforestation_rate_pct,\n    ei.agricultural_area_km2,\n    ei.pasture_area_km2,\n    ei.permanent_crops_area_km2,\n    ei.temporary_crops_area_km2,\n    ei.protected_areas_km2,\n    ei.protected_areas_pct,\n    ei.water_bodies_km2,\n    ei.rainfall_mm_year,\n    ei.avg_temperature_celsius,\n    ei.drought_risk_index,\n    ei.fire_hotspots_count,\n    ei.environmental_fines_count,\n    ei.environmental_fines_value_brl\n  FROM environmental_indicators ei\n  WHERE ei.territory_id = '{{ $('Normalizar Entrada').first().json.territory_id }}'\n    AND ei.year >= 2019\n    AND ei.year <= 2023\n)\n\n-- 5. UNIÃƒO DE TODAS AS DIMENSÃ•ES\nSELECT \n  -- IdentificaÃ§Ã£o do territÃ³rio\n  td.territory_id,\n  td.territory_name,\n  td.territory_type,\n  td.territory_area_km2,\n  td.population,\n  \n  -- Ano de referÃªncia\n  COALESCE(ed.economic_year, sd.social_year, td.territorial_year, envd.environmental_year) AS year,\n  \n  -- DIMENSÃƒO ECONÃ”MICA\n  ed.gdp_millions,\n  ed.gdp_per_capita,\n  ed.employment_rate,\n  ed.formal_employment_count,\n  ed.informal_employment_est_pct,\n  ed.average_salary,\n  ed.municipal_revenue,\n  ed.own_revenue,\n  ed.transfer_revenue,\n  ed.fiscal_dependency_pct,\n  ed.sector_distribution,\n  ed.agriculture_gdp_pct,\n  ed.industry_gdp_pct,\n  ed.services_gdp_pct,\n  ed.public_admin_gdp_pct,\n  ed.exports_usd,\n  ed.imports_usd,\n  ed.trade_balance_usd,\n  ed.credit_volume_millions,\n  ed.business_count,\n  ed.micro_business_pct,\n  ed.small_business_pct,\n  ed.medium_business_pct,\n  ed.large_business_pct,\n  \n  -- DIMENSÃƒO SOCIAL (Contexto para economia)\n  sd.ideb_initial_years,\n  sd.ideb_final_years,\n  sd.illiteracy_rate_pct,\n  sd.higher_education_pct,\n  sd.poverty_rate_pct,\n  sd.extreme_poverty_rate_pct,\n  sd.gini_index,\n  sd.unemployment_rate_pct AS social_unemployment_rate_pct,\n  sd.informal_work_pct AS social_informal_work_pct,\n  sd.child_mortality_per_1000,\n  sd.life_expectancy_years,\n  sd.basic_sanitation_coverage_pct,\n  sd.treated_water_coverage_pct,\n  sd.sewage_coverage_pct,\n  sd.solid_waste_collection_pct,\n  sd.bolsa_familia_families,\n  sd.bolsa_familia_coverage_pct,\n  \n  -- DIMENSÃƒO TERRITORIAL (Infraestrutura para economia)\n  td.urban_area_km2,\n  td.rural_area_km2,\n  td.road_network_km,\n  td.paved_roads_km,\n  td.unpaved_roads_km,\n  td.distance_to_capital_km,\n  td.distance_to_nearest_port_km,\n  td.has_airport,\n  td.has_railway,\n  td.has_waterway,\n  td.internet_coverage_pct,\n  td.mobile_coverage_pct,\n  td.electricity_coverage_pct,\n  \n  -- DIMENSÃƒO AMBIENTAL (Impacto na agropecuÃ¡ria)\n  envd.forest_cover_km2,\n  envd.forest_cover_pct,\n  envd.deforestation_km2_year,\n  envd.deforestation_rate_pct,\n  envd.agricultural_area_km2,\n  envd.pasture_area_km2,\n  envd.permanent_crops_area_km2,\n  envd.temporary_crops_area_km2,\n  envd.protected_areas_km2,\n  envd.protected_areas_pct,\n  envd.water_bodies_km2,\n  envd.rainfall_mm_year,\n  envd.avg_temperature_celsius,\n  envd.drought_risk_index,\n  envd.fire_hotspots_count,\n  envd.environmental_fines_count,\n  envd.environmental_fines_value_brl,\n  \n  -- Metadados\n  'multidimensional' AS data_type,\n  'IBGE, SICONFI, RAIS, INPE, ANA, ICMBio' AS data_sources\n\nFROM territory_data td\nLEFT JOIN economic_data ed ON td.territory_id = ed.territory_id\nLEFT JOIN social_data sd ON td.territory_id = sd.territory_id \n  AND COALESCE(ed.economic_year, sd.social_year) = sd.social_year\nLEFT JOIN environmental_data envd ON td.territory_id = envd.territory_id\n  AND COALESCE(ed.economic_year, envd.environmental_year) = envd.environmental_year\n\nWHERE COALESCE(ed.economic_year, sd.social_year, td.territorial_year, envd.environmental_year) >= 2019\n  AND COALESCE(ed.economic_year, sd.social_year, td.territorial_year, envd.environmental_year) <= 2023\n\nORDER BY year DESC;\n\n-- ========================================\n-- JUSTIFICATIVA DA ABORDAGEM MULTIDIMENSIONAL\n-- ========================================\n--\n-- Esta query expande significativamente o contexto para anÃ¡lise econÃ´mica:\n--\n-- 1. DIMENSÃƒO SOCIAL â†’ ECONOMIA:\n--    - IDEB e escolaridade â†’ Qualidade da forÃ§a de trabalho\n--    - Pobreza e Gini â†’ Desigualdade e poder de compra\n--    - Saneamento â†’ SaÃºde e produtividade\n--\n-- 2. DIMENSÃƒO TERRITORIAL â†’ ECONOMIA:\n--    - Infraestrutura logÃ­stica â†’ Custos de transporte e competitividade\n--    - Conectividade digital â†’ Acesso a mercados e serviÃ§os\n--    - DistÃ¢ncia a portos â†’ Viabilidade de exportaÃ§Ãµes\n--\n-- 3. DIMENSÃƒO AMBIENTAL â†’ ECONOMIA:\n--    - Ãrea agrÃ­cola e pastagens â†’ Base produtiva agropecuÃ¡ria\n--    - Desmatamento â†’ Sustentabilidade e riscos regulatÃ³rios\n--    - Clima e chuvas â†’ Produtividade agrÃ­cola\n--\n-- RESULTADO: AnÃ¡lise econÃ´mica contextualizada e profunda, identificando\n-- fatores estruturais que explicam desempenho econÃ´mico e oportunidades\n-- de desenvolvimento sustentÃ¡vel.\n",
        "options": {
          "queryBatching": "transaction"
        }
      },
      "id": "251ef152-05a2-4d73-b50f-16bf0cf121fc",
      "name": "Consultar Dados PostgreSQL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        176,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "SVnYhSNx3vXIzoYk",
          "name": "Postgres Replit"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "Consulta MULTIDIMENSIONAL expandida que traz:\n- Dados econÃ´micos (PIB, emprego, finanÃ§as)\n- Dados sociais (educaÃ§Ã£o, pobreza, saneamento)\n- Dados territoriais (infraestrutura, conectividade)\n- Dados ambientais (uso do solo, clima, desmatamento)\n\nEsta abordagem permite anÃ¡lise econÃ´mica contextualizada e profunda."
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// PREPARAR CONTEXTO PARA LLM (V4 - MULTIDIMENSIONAL)\n// VersÃ£o: 4.0\n// Data: 30/11/2025\n// DescriÃ§Ã£o: Integra dados multidimensionais (econÃ´micos, sociais,\n//            territoriais, ambientais) + memÃ³ria RAG para anÃ¡lise profunda\n// ========================================\n\n// Pega os dados normalizados do webhook\nconst normalizedData = $items(\"Normalizar Entrada\")[0].json;\n\n// Pega a memÃ³ria e aprendizados (Camadas 1, 2, 4 do RAG)\nconst memoryData = $items(\"Consultar MemÃ³ria e Aprendizados\")[0].json;\n\n// Pega os dados multidimensionais\nconst rawData = $items(\"Consultar Dados PostgreSQL\")[0].json;\n\n// ========================================\n// FUNÃ‡Ã•ES AUXILIARES\n// ========================================\n\nfunction formatCurrency(value) {\n  if (!value) return \"N/A\";\n  return new Intl.NumberFormat('pt-BR', { \n    style: 'currency', \n    currency: 'BRL',\n    minimumFractionDigits: 0,\n    maximumFractionDigits: 0\n  }).format(value * 1000000); // Converte milhÃµes para reais\n}\n\nfunction formatNumber(value, decimals = 0) {\n  if (value === null || value === undefined) return \"N/A\";\n  return new Intl.NumberFormat('pt-BR', {\n    minimumFractionDigits: decimals,\n    maximumFractionDigits: decimals\n  }).format(value);\n}\n\nfunction formatPercent(value, decimals = 1) {\n  if (value === null || value === undefined) return \"N/A\";\n  return `${formatNumber(value, decimals)}%`;\n}\n\n// ========================================\n// PROCESSAR MEMÃ“RIA RAG\n// ========================================\n\nlet memorySection = \"\";\nlet learningsSection = \"\";\nlet expertiseSection = \"\";\n\nif (memoryData && Array.isArray(memoryData)) {\n  // Separar anÃ¡lises anteriores, aprendizados e expertise\n  const previousAnalyses = memoryData.filter(row => row.analysis_content);\n  const learnings = memoryData.filter(row => row.synthesis);\n  const expertise = memoryData.filter(row => row.expertise_level);\n  \n  // SeÃ§Ã£o de anÃ¡lises anteriores\n  if (previousAnalyses.length > 0) {\n    memorySection = `\\n## ğŸ“š ANÃLISES ANTERIORES DESTE TERRITÃ“RIO\\n\\n`;\n    memorySection += `VocÃª jÃ¡ analisou **${normalizedData.territory_name}** ${previousAnalyses.length} vez(es) anteriormente:\\n\\n`;\n    \n    previousAnalyses.forEach((analysis, index) => {\n      const date = new Date(analysis.created_at).toLocaleDateString('pt-BR');\n      memorySection += `### AnÃ¡lise ${index + 1} (${date})\\n`;\n      memorySection += `- **Resumo:** ${analysis.analysis_summary}\\n`;\n      memorySection += `- **ConfianÃ§a:** ${formatPercent(analysis.confidence_score * 100, 0)}\\n\\n`;\n    });\n    \n    memorySection += `**IMPORTANTE:** Use essas anÃ¡lises anteriores para:\\n`;\n    memorySection += `- Identificar **mudanÃ§as e tendÃªncias** ao longo do tempo\\n`;\n    memorySection += `- Evitar **repetir as mesmas conclusÃµes**\\n`;\n    memorySection += `- **Aprofundar insights** que foram superficiais antes\\n`;\n    memorySection += `- **Validar ou refutar** hipÃ³teses anteriores\\n\\n`;\n  }\n  \n  // SeÃ§Ã£o de aprendizados\n  if (learnings.length > 0) {\n    learningsSection = `\\n## ğŸ§  APRENDIZADOS ACUMULADOS\\n\\n`;\n    learningsSection += `VocÃª acumulou ${learnings.length} aprendizados ao longo de suas anÃ¡lises econÃ´micas:\\n\\n`;\n    \n    learnings.slice(0, 5).forEach((learning, index) => {\n      learningsSection += `### Aprendizado ${index + 1}\\n`;\n      learningsSection += `${learning.synthesis}\\n\\n`;\n    });\n  }\n  \n  // SeÃ§Ã£o de expertise\n  if (expertise.length > 0) {\n    const exp = expertise[0];\n    expertiseSection = `\\n## ğŸ¯ SEU NÃVEL DE EXPERTISE\\n\\n`;\n    expertiseSection += `- **NÃ­vel:** ${exp.expertise_level}\\n`;\n    expertiseSection += `- **ExperiÃªncia:** ${exp.analysis_count} anÃ¡lises realizadas\\n`;\n    expertiseSection += `- **ConfianÃ§a MÃ©dia:** ${formatPercent(exp.avg_confidence * 100, 0)}\\n\\n`;\n  }\n}\n\n// ========================================\n// PROCESSAR DADOS MULTIDIMENSIONAIS\n// ========================================\n\nlet contextText = \"\";\n\nif (!rawData || (Array.isArray(rawData) && rawData.length === 0)) {\n  contextText = `\\n## âš ï¸ DADOS NÃƒO DISPONÃVEIS\\n\\nNÃ£o hÃ¡ dados disponÃ­veis para ${normalizedData.territory_name} no perÃ­odo solicitado.\\n\\n`;\n} else {\n  const data = Array.isArray(rawData) ? rawData : [rawData];\n  const latestYear = data[0]; // Dados mais recentes\n  const oldestYear = data[data.length - 1]; // Dados mais antigos\n  \n  // ========================================\n  // 1. VISÃƒO GERAL DO TERRITÃ“RIO\n  // ========================================\n  \n  contextText += `\\n## ğŸ—ºï¸ VISÃƒO GERAL DO TERRITÃ“RIO\\n\\n`;\n  contextText += `**Nome:** ${latestYear.territory_name}\\n`;\n  contextText += `**Tipo:** ${latestYear.territory_type}\\n`;\n  contextText += `**Ãrea:** ${formatNumber(latestYear.territory_area_km2, 2)} kmÂ²\\n`;\n  contextText += `**PopulaÃ§Ã£o:** ${formatNumber(latestYear.population)} habitantes\\n`;\n  contextText += `**Densidade DemogrÃ¡fica:** ${formatNumber(latestYear.population / latestYear.territory_area_km2, 2)} hab/kmÂ²\\n\\n`;\n  \n  // ========================================\n  // 2. DIMENSÃƒO ECONÃ”MICA (Principal)\n  // ========================================\n  \n  contextText += `\\n## ğŸ’° DIMENSÃƒO ECONÃ”MICA (${latestYear.year})\\n\\n`;\n  \n  contextText += `### Produto Interno Bruto\\n`;\n  contextText += `- **PIB Total:** ${formatCurrency(latestYear.gdp_millions)}\\n`;\n  contextText += `- **PIB per capita:** ${formatCurrency(latestYear.gdp_per_capita / 1000000)}\\n`;\n  \n  if (data.length > 1) {\n    const gdpGrowth = ((latestYear.gdp_millions - oldestYear.gdp_millions) / oldestYear.gdp_millions) * 100;\n    contextText += `- **Crescimento ${oldestYear.year}-${latestYear.year}:** ${formatPercent(gdpGrowth, 1)}\\n`;\n  }\n  contextText += `\\n`;\n  \n  contextText += `### Estrutura Setorial\\n`;\n  contextText += `- **AgropecuÃ¡ria:** ${formatPercent(latestYear.agriculture_gdp_pct)}\\n`;\n  contextText += `- **IndÃºstria:** ${formatPercent(latestYear.industry_gdp_pct)}\\n`;\n  contextText += `- **ServiÃ§os:** ${formatPercent(latestYear.services_gdp_pct)}\\n`;\n  contextText += `- **AdministraÃ§Ã£o PÃºblica:** ${formatPercent(latestYear.public_admin_gdp_pct)}\\n\\n`;\n  \n  contextText += `### Mercado de Trabalho\\n`;\n  contextText += `- **Taxa de Emprego:** ${formatPercent(latestYear.employment_rate)}\\n`;\n  contextText += `- **Empregos Formais:** ${formatNumber(latestYear.formal_employment_count)}\\n`;\n  contextText += `- **Informalidade Estimada:** ${formatPercent(latestYear.informal_employment_est_pct)}\\n`;\n  contextText += `- **SalÃ¡rio MÃ©dio:** ${formatCurrency(latestYear.average_salary / 1000000)}\\n\\n`;\n  \n  contextText += `### FinanÃ§as PÃºblicas\\n`;\n  contextText += `- **Receita Municipal:** ${formatCurrency(latestYear.municipal_revenue)}\\n`;\n  contextText += `- **Receita PrÃ³pria:** ${formatCurrency(latestYear.own_revenue)}\\n`;\n  contextText += `- **TransferÃªncias:** ${formatCurrency(latestYear.transfer_revenue)}\\n`;\n  contextText += `- **DependÃªncia Fiscal:** ${formatPercent(latestYear.fiscal_dependency_pct)}\\n\\n`;\n  \n  if (latestYear.exports_usd || latestYear.imports_usd) {\n    contextText += `### ComÃ©rcio Exterior\\n`;\n    contextText += `- **ExportaÃ§Ãµes:** US$ ${formatNumber(latestYear.exports_usd)}\\n`;\n    contextText += `- **ImportaÃ§Ãµes:** US$ ${formatNumber(latestYear.imports_usd)}\\n`;\n    contextText += `- **Saldo Comercial:** US$ ${formatNumber(latestYear.trade_balance_usd)}\\n\\n`;\n  }\n  \n  if (latestYear.business_count) {\n    contextText += `### Estrutura Empresarial\\n`;\n    contextText += `- **Total de Empresas:** ${formatNumber(latestYear.business_count)}\\n`;\n    contextText += `- **Microempresas:** ${formatPercent(latestYear.micro_business_pct)}\\n`;\n    contextText += `- **Pequenas:** ${formatPercent(latestYear.small_business_pct)}\\n`;\n    contextText += `- **MÃ©dias:** ${formatPercent(latestYear.medium_business_pct)}\\n`;\n    contextText += `- **Grandes:** ${formatPercent(latestYear.large_business_pct)}\\n\\n`;\n  }\n  \n  // ========================================\n  // 3. DIMENSÃƒO SOCIAL (Contexto para Economia)\n  // ========================================\n  \n  if (latestYear.ideb_initial_years || latestYear.poverty_rate_pct) {\n    contextText += `\\n## ğŸ‘¥ DIMENSÃƒO SOCIAL (Impacto na Economia)\\n\\n`;\n    \n    if (latestYear.ideb_initial_years) {\n      contextText += `### EducaÃ§Ã£o (Qualidade da ForÃ§a de Trabalho)\\n`;\n      contextText += `- **IDEB Anos Iniciais:** ${formatNumber(latestYear.ideb_initial_years, 1)}\\n`;\n      contextText += `- **IDEB Anos Finais:** ${formatNumber(latestYear.ideb_final_years, 1)}\\n`;\n      contextText += `- **Taxa de Analfabetismo:** ${formatPercent(latestYear.illiteracy_rate_pct)}\\n`;\n      contextText += `- **Ensino Superior:** ${formatPercent(latestYear.higher_education_pct)}\\n`;\n      contextText += `\\n**ImplicaÃ§Ã£o EconÃ´mica:** EducaÃ§Ã£o de qualidade aumenta produtividade e atrai investimentos.\\n\\n`;\n    }\n    \n    if (latestYear.poverty_rate_pct) {\n      contextText += `### Pobreza e Desigualdade (Poder de Compra)\\n`;\n      contextText += `- **Taxa de Pobreza:** ${formatPercent(latestYear.poverty_rate_pct)}\\n`;\n      contextText += `- **Pobreza Extrema:** ${formatPercent(latestYear.extreme_poverty_rate_pct)}\\n`;\n      contextText += `- **Ãndice de Gini:** ${formatNumber(latestYear.gini_index, 3)}\\n`;\n      contextText += `- **FamÃ­lias no Bolsa FamÃ­lia:** ${formatNumber(latestYear.bolsa_familia_families)}\\n`;\n      contextText += `\\n**ImplicaÃ§Ã£o EconÃ´mica:** Alta pobreza limita mercado consumidor e demanda agregada.\\n\\n`;\n    }\n    \n    if (latestYear.basic_sanitation_coverage_pct) {\n      contextText += `### Saneamento BÃ¡sico (SaÃºde e Produtividade)\\n`;\n      contextText += `- **Cobertura de Saneamento:** ${formatPercent(latestYear.basic_sanitation_coverage_pct)}\\n`;\n      contextText += `- **Ãgua Tratada:** ${formatPercent(latestYear.treated_water_coverage_pct)}\\n`;\n      contextText += `- **Esgotamento SanitÃ¡rio:** ${formatPercent(latestYear.sewage_coverage_pct)}\\n`;\n      contextText += `- **Coleta de Lixo:** ${formatPercent(latestYear.solid_waste_collection_pct)}\\n`;\n      contextText += `\\n**ImplicaÃ§Ã£o EconÃ´mica:** Saneamento precÃ¡rio reduz produtividade por doenÃ§as.\\n\\n`;\n    }\n  }\n  \n  // ========================================\n  // 4. DIMENSÃƒO TERRITORIAL (Infraestrutura)\n  // ========================================\n  \n  if (latestYear.road_network_km || latestYear.internet_coverage_pct) {\n    contextText += `\\n## ğŸ›£ï¸ DIMENSÃƒO TERRITORIAL (Infraestrutura para Economia)\\n\\n`;\n    \n    if (latestYear.road_network_km) {\n      contextText += `### Infraestrutura LogÃ­stica\\n`;\n      contextText += `- **Rede ViÃ¡ria Total:** ${formatNumber(latestYear.road_network_km, 0)} km\\n`;\n      contextText += `- **Estradas Pavimentadas:** ${formatNumber(latestYear.paved_roads_km, 0)} km (${formatPercent((latestYear.paved_roads_km / latestYear.road_network_km) * 100)})\\n`;\n      contextText += `- **DistÃ¢ncia Ã  Capital:** ${formatNumber(latestYear.distance_to_capital_km, 0)} km\\n`;\n      contextText += `- **DistÃ¢ncia ao Porto Mais PrÃ³ximo:** ${formatNumber(latestYear.distance_to_nearest_port_km, 0)} km\\n`;\n      contextText += `- **Aeroporto:** ${latestYear.has_airport ? 'Sim' : 'NÃ£o'}\\n`;\n      contextText += `- **Ferrovia:** ${latestYear.has_railway ? 'Sim' : 'NÃ£o'}\\n`;\n      contextText += `- **Hidrovia:** ${latestYear.has_waterway ? 'Sim' : 'NÃ£o'}\\n`;\n      contextText += `\\n**ImplicaÃ§Ã£o EconÃ´mica:** Infraestrutura logÃ­stica reduz custos de transporte e aumenta competitividade.\\n\\n`;\n    }\n    \n    if (latestYear.internet_coverage_pct) {\n      contextText += `### Conectividade Digital\\n`;\n      contextText += `- **Cobertura de Internet:** ${formatPercent(latestYear.internet_coverage_pct)}\\n`;\n      contextText += `- **Cobertura de Celular:** ${formatPercent(latestYear.mobile_coverage_pct)}\\n`;\n      contextText += `- **Cobertura de Energia ElÃ©trica:** ${formatPercent(latestYear.electricity_coverage_pct)}\\n`;\n      contextText += `\\n**ImplicaÃ§Ã£o EconÃ´mica:** Conectividade digital viabiliza e-commerce, serviÃ§os remotos e acesso a mercados.\\n\\n`;\n    }\n  }\n  \n  // ========================================\n  // 5. DIMENSÃƒO AMBIENTAL (AgropecuÃ¡ria)\n  // ========================================\n  \n  if (latestYear.agricultural_area_km2 || latestYear.forest_cover_pct) {\n    contextText += `\\n## ğŸŒ³ DIMENSÃƒO AMBIENTAL (Base Produtiva AgropecuÃ¡ria)\\n\\n`;\n    \n    if (latestYear.agricultural_area_km2) {\n      contextText += `### Uso do Solo\\n`;\n      contextText += `- **Ãrea AgrÃ­cola Total:** ${formatNumber(latestYear.agricultural_area_km2, 0)} kmÂ² (${formatPercent((latestYear.agricultural_area_km2 / latestYear.territory_area_km2) * 100)})\\n`;\n      contextText += `- **Pastagens:** ${formatNumber(latestYear.pasture_area_km2, 0)} kmÂ²\\n`;\n      contextText += `- **Lavouras TemporÃ¡rias:** ${formatNumber(latestYear.temporary_crops_area_km2, 0)} kmÂ²\\n`;\n      contextText += `- **Lavouras Permanentes:** ${formatNumber(latestYear.permanent_crops_area_km2, 0)} kmÂ²\\n`;\n      contextText += `\\n**ImplicaÃ§Ã£o EconÃ´mica:** Ãrea agrÃ­cola define potencial produtivo agropecuÃ¡rio.\\n\\n`;\n    }\n    \n    if (latestYear.forest_cover_pct) {\n      contextText += `### Cobertura Florestal e Sustentabilidade\\n`;\n      contextText += `- **Cobertura Florestal:** ${formatNumber(latestYear.forest_cover_km2, 0)} kmÂ² (${formatPercent(latestYear.forest_cover_pct)})\\n`;\n      contextText += `- **Desmatamento Anual:** ${formatNumber(latestYear.deforestation_km2_year, 2)} kmÂ²/ano\\n`;\n      contextText += `- **Taxa de Desmatamento:** ${formatPercent(latestYear.deforestation_rate_pct)}\\n`;\n      contextText += `- **Ãreas Protegidas:** ${formatNumber(latestYear.protected_areas_km2, 0)} kmÂ² (${formatPercent(latestYear.protected_areas_pct)})\\n`;\n      contextText += `\\n**ImplicaÃ§Ã£o EconÃ´mica:** Desmatamento excessivo gera riscos regulatÃ³rios e restriÃ§Ãµes a exportaÃ§Ãµes.\\n\\n`;\n    }\n    \n    if (latestYear.rainfall_mm_year) {\n      contextText += `### Clima e Produtividade AgrÃ­cola\\n`;\n      contextText += `- **PrecipitaÃ§Ã£o Anual:** ${formatNumber(latestYear.rainfall_mm_year, 0)} mm\\n`;\n      contextText += `- **Temperatura MÃ©dia:** ${formatNumber(latestYear.avg_temperature_celsius, 1)}Â°C\\n`;\n      contextText += `- **Ãndice de Risco de Seca:** ${formatNumber(latestYear.drought_risk_index, 2)}\\n`;\n      contextText += `- **Focos de IncÃªndio:** ${formatNumber(latestYear.fire_hotspots_count)}\\n`;\n      contextText += `\\n**ImplicaÃ§Ã£o EconÃ´mica:** Clima impacta diretamente produtividade agrÃ­cola e riscos de safra.\\n\\n`;\n    }\n  }\n  \n  // ========================================\n  // 6. SÃ‰RIE TEMPORAL (se disponÃ­vel)\n  // ========================================\n  \n  if (data.length > 1) {\n    contextText += `\\n## ğŸ“ˆ EVOLUÃ‡ÃƒO TEMPORAL (${oldestYear.year}-${latestYear.year})\\n\\n`;\n    contextText += `| Indicador | ${oldestYear.year} | ${latestYear.year} | VariaÃ§Ã£o |\\n`;\n    contextText += `|-----------|------------|------------|----------|\\n`;\n    \n    const indicators = [\n      { label: 'PIB (R$ milhÃµes)', old: oldestYear.gdp_millions, new: latestYear.gdp_millions, format: 'currency' },\n      { label: 'PIB per capita (R$)', old: oldestYear.gdp_per_capita, new: latestYear.gdp_per_capita, format: 'currency_small' },\n      { label: 'Empregos Formais', old: oldestYear.formal_employment_count, new: latestYear.formal_employment_count, format: 'number' },\n      { label: 'SalÃ¡rio MÃ©dio (R$)', old: oldestYear.average_salary, new: latestYear.average_salary, format: 'currency_small' },\n      { label: 'Receita Municipal (R$ milhÃµes)', old: oldestYear.municipal_revenue, new: latestYear.municipal_revenue, format: 'currency' }\n    ];\n    \n    indicators.forEach(ind => {\n      if (ind.old && ind.new) {\n        const variation = ((ind.new - ind.old) / ind.old) * 100;\n        const arrow = variation > 0 ? 'â†—ï¸' : (variation < 0 ? 'â†˜ï¸' : 'â¡ï¸');\n        \n        let oldVal, newVal;\n        if (ind.format === 'currency') {\n          oldVal = formatCurrency(ind.old);\n          newVal = formatCurrency(ind.new);\n        } else if (ind.format === 'currency_small') {\n          oldVal = formatCurrency(ind.old / 1000000);\n          newVal = formatCurrency(ind.new / 1000000);\n        } else {\n          oldVal = formatNumber(ind.old);\n          newVal = formatNumber(ind.new);\n        }\n        \n        contextText += `| ${ind.label} | ${oldVal} | ${newVal} | ${arrow} ${formatPercent(Math.abs(variation), 1)} |\\n`;\n      }\n    });\n    contextText += `\\n`;\n  }\n}\n\n// ========================================\n// MONTAR PROMPT FINAL PARA O LLM\n// ========================================\n\nconst finalPrompt = `\n# ANÃLISE ECONÃ”MICA MULTIDIMENSIONAL\n\nVocÃª Ã© o **Agente ECON**, especialista em anÃ¡lise econÃ´mica de territÃ³rios. Sua missÃ£o Ã© gerar uma anÃ¡lise econÃ´mica **profunda, contextualizada e acionÃ¡vel** de **${normalizedData.territory_name}**.\n\n${expertiseSection}\n\n${memorySection}\n\n${learningsSection}\n\n${contextText}\n\n---\n\n## ğŸ“‹ INSTRUÃ‡Ã•ES PARA A ANÃLISE\n\n### Estrutura da AnÃ¡lise\n\n1. **Resumo Executivo** (3-4 parÃ¡grafos)\n   - SÃ­ntese dos principais achados econÃ´micos\n   - Destaque para mudanÃ§as significativas (se houver anÃ¡lises anteriores)\n   - Principais oportunidades e desafios\n\n2. **AnÃ¡lise EconÃ´mica Detalhada**\n   - Estrutura produtiva e setores dinÃ¢micos\n   - Mercado de trabalho e qualidade dos empregos\n   - Sustentabilidade fiscal e capacidade de investimento\n   - ComÃ©rcio exterior e inserÃ§Ã£o em cadeias produtivas (se aplicÃ¡vel)\n\n3. **AnÃ¡lise Multidimensional Integrada** â­ NOVO\n   - Como educaÃ§Ã£o e capital humano impactam a economia?\n   - Como infraestrutura logÃ­stica afeta competitividade?\n   - Como fatores ambientais influenciam agropecuÃ¡ria?\n   - Como pobreza e desigualdade limitam mercado consumidor?\n\n4. **ComparaÃ§Ã£o Temporal** (se houver dados de mÃºltiplos anos)\n   - TendÃªncias de crescimento ou estagnaÃ§Ã£o\n   - MudanÃ§as estruturais na economia\n   - Efetividade de polÃ­ticas pÃºblicas implementadas\n\n5. **RecomendaÃ§Ãµes EstratÃ©gicas**\n   - PolÃ­ticas de desenvolvimento econÃ´mico prioritÃ¡rias\n   - Oportunidades de diversificaÃ§Ã£o produtiva\n   - Investimentos em infraestrutura crÃ­tica\n   - AÃ§Ãµes para reduzir dependÃªncia fiscal\n\n### Diretrizes de Qualidade\n\n- **Use TODOS os dados disponÃ­veis** (econÃ´micos, sociais, territoriais, ambientais)\n- **Identifique interconexÃµes** entre dimensÃµes (ex: saneamento â†’ produtividade)\n- **Compare com anÃ¡lises anteriores** (se houver) e destaque mudanÃ§as\n- **Aplique aprendizados acumulados** em sua anÃ¡lise\n- **Seja especÃ­fico e quantitativo** (cite nÃºmeros, percentuais, valores)\n- **Evite jargÃ£o tÃ©cnico excessivo** (anÃ¡lise deve ser acessÃ­vel a gestores)\n- **Foque em insights acionÃ¡veis** (nÃ£o apenas descrever dados)\n\n---\n\n**Gere agora a anÃ¡lise econÃ´mica multidimensional completa.**\n`;\n\n// Retorna o prompt final\nreturn { json: { prompt: finalPrompt, metadata: normalizedData } };\n"
      },
      "id": "adb7d994-8b41-4aad-adda-74f9ea8d1bd7",
      "name": "Preparar Contexto para LLM (V4 Multidimensional)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        0
      ],
      "notes": "VersÃ£o 4.0 - MULTIDIMENSIONAL\n\nProcessa dados de 4 dimensÃµes:\n1. EconÃ´mica (principal)\n2. Social (contexto)\n3. Territorial (infraestrutura)\n4. Ambiental (agropecuÃ¡ria)\n\nIntegra memÃ³ria RAG (Camadas 1, 2, 4) para anÃ¡lise evolutiva.\n\nGera prompt estruturado que instrui o LLM a:\n- Usar TODOS os dados disponÃ­veis\n- Identificar interconexÃµes entre dimensÃµes\n- Comparar com anÃ¡lises anteriores\n- Aplicar aprendizados acumulados\n- Focar em insights acionÃ¡veis"
    },
    {
      "parameters": {
        "modelId": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "GPT-4O-MINI"
        },
        "messages": {
          "values": [
            {
              "content": "={{ $json.user_prompt }}"
            },
            {
              "content": "VocÃª Ã© um especialista em anÃ¡lise econÃ´mica de municÃ­pios brasileiros. Sua funÃ§Ã£o Ã© gerar anÃ¡lises profundas e baseadas em dados reais, com foco em indicadores econÃ´micos, PIB, emprego, renda e desenvolvimento.",
              "role": "system"
            },
            {
              "content": "REGRAS FUNDAMENTAIS:\n\n1. FIDELIDADE AOS DADOS:\n   - NUNCA crie dados sintÃ©ticos ou invente informaÃ§Ãµes\n   - Se um dado nÃ£o estiver disponÃ­vel nos dados fornecidos, indique: \"Dado nÃ£o disponÃ­vel para este perÃ­odo\"\n   - Base TODAS as afirmaÃ§Ãµes exclusivamente nos dados fornecidos\n   - Cite sempre a fonte: ano, indicador e valor exato\n\n2. TOM E ESTILO:\n   - Use linguagem tÃ©cnica mas acessÃ­vel para gestores pÃºblicos\n   - Seja objetivo e direto nas conclusÃµes\n   - Evite jargÃµes excessivos - explique termos tÃ©cnicos quando necessÃ¡rio\n\n3. ESTRUTURA DA ANÃLISE:\n   - **RESUMO EXECUTIVO:** Principais achados em 2-3 parÃ¡grafos\n   - **INDICADORES-CHAVE:** NÃºmeros mais importantes com contexto\n   - **TENDÃŠNCIAS IDENTIFICADAS:** PadrÃµes ao longo do tempo\n   - **ANÃLISE COMPARATIVA:** ComparaÃ§Ãµes quando dados disponÃ­veis\n   - **RECOMENDAÃ‡Ã•ES:** Baseadas exclusivamente nos dados apresentados\n\n4. FORMATAÃ‡ÃƒO:\n   - Use Markdown para estruturaÃ§Ã£o\n   - Destaque nÃºmeros importantes em **negrito**\n   - Use listas para facilitar leitura\n   - Inclua tabelas quando apropriado\n   - Cite sempre: \"PIB 2023: R$ X milhÃµes (fonte: IBGE)\"\n\n5. PROIBIÃ‡Ã•ES:\n   - NÃƒO especule sobre causas sem dados que as sustentem\n   - NÃƒO faÃ§a previsÃµes futuras (apenas tendÃªncias baseadas em histÃ³rico)\n   - NÃƒO use frases genÃ©ricas como \"a economia estÃ¡ crescendo\" sem quantificar\n   - NÃƒO invente contextos polÃ­ticos ou sociais nÃ£o presentes nos dados\n\nExemplo de anÃ¡lise correta:\n\"O PIB de Palmas cresceu 12,5% entre 2019 e 2023, passando de R$ 8,2 bilhÃµes para R$ 9,2 bilhÃµes. Este crescimento foi impulsionado principalmente pelo setor de serviÃ§os, que representa 78% do PIB municipal.\"\n\nExemplo de anÃ¡lise INCORRETA:\n\"A economia estÃ¡ indo bem e deve continuar crescendo nos prÃ³ximos anos devido a investimentos.\" (especulaÃ§Ã£o sem dados)\n",
              "role": "assistant"
            }
          ]
        },
        "options": {
          "maxTokens": 2000,
          "temperature": 0.7
        }
      },
      "id": "b33d80b9-dd9b-4fd2-8935-a2e7efee8764",
      "name": "Gerar AnÃ¡lise com OpenAI",
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.7,
      "position": [
        576,
        0
      ],
      "credentials": {
        "openAiApi": {
          "id": "91zlCtPqrVu6rXoF",
          "name": "OpenAi account 2"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "FUNÃ‡ÃƒO: Gerar anÃ¡lise econÃ´mica usando LLM da OpenAI.\n\nATUALIZAÃ‡Ã•ES V2 (CRÃTICAS):\n- type: 'n8n-nodes-base.openAi' â†’ '@n8n/n8n-nodes-langchain.openAi'\n- typeVersion: 1 â†’ 1.7 (versÃ£o mais recente)\n- Estrutura completamente nova:\n  â€¢ resource: 'text' (operaÃ§Ã£o de texto)\n  â€¢ operation: 'message' (gerar chat completion)\n  â€¢ messages.values: Array de mensagens com role + content\n  â€¢ options: ParÃ¢metros avanÃ§ados (temperature, maxTokens)\n\nO QUE FAZ:\n1. Recebe prompt estruturado do nÃ³ anterior\n2. Envia para API da OpenAI (Chat Completions)\n3. Usa modelo gpt-4o-mini (rÃ¡pido e econÃ´mico)\n4. Retorna anÃ¡lise econÃ´mica em Markdown\n\nPARÃ‚METROS:\n- model: 'gpt-4o-mini' (Ã³timo custo-benefÃ­cio)\n- temperature: 0.7 (equilÃ­brio entre criatividade e consistÃªncia)\n- maxTokens: 1500 (suficiente para anÃ¡lise de ~400 palavras)\n\nPOR QUE GPT-4O-MINI?\n- Custo: ~15x mais barato que GPT-4\n- Velocidade: ~2x mais rÃ¡pido\n- Qualidade: Suficiente para anÃ¡lises estruturadas\n- Contexto: 128k tokens (mais que suficiente)\n\nTEMPERATURE 0.7:\n- 0.0 = DeterminÃ­stico (sempre mesma resposta)\n- 0.7 = EquilÃ­brio (consistente mas com variaÃ§Ã£o)\n- 1.0 = Criativo (mais variaÃ§Ã£o)\n\nTEMPO DE RESPOSTA:\n- TÃ­pico: 3-5 segundos\n- Depende de:\n  â€¢ Tamanho do prompt\n  â€¢ Carga na API OpenAI\n  â€¢ Complexidade da anÃ¡lise\n\nOUTPUT:\nObjeto JSON com estrutura:\n{\n  \"message\": {\n    \"role\": \"assistant\",\n    \"content\": \"**RESUMO EXECUTIVO**\\n\\nPalmas apresenta...\"\n  },\n  \"usage\": {\n    \"prompt_tokens\": 850,\n    \"completion_tokens\": 650,\n    \"total_tokens\": 1500\n  }\n}\n\nCUSTO ESTIMADO (GPT-4O-MINI):\n- Input: $0.150 / 1M tokens\n- Output: $0.600 / 1M tokens\n- Custo por anÃ¡lise: ~$0.0015 (R$ 0,0075)\n- 1000 anÃ¡lises: ~$1.50 (R$ 7,50)"
    },
    {
      "parameters": {
        "jsCode": "// ========================================\n// ESTRUTURAR RESPOSTA FINAL\n// ========================================\n// Este nÃ³ consolida a anÃ¡lise do LLM com metadados e prepara resposta estruturada.\n\nconst items = $input.all();\nconst llmResponse = items[0].json.message.content;\n\n// Recuperar dados do nÃ³ anterior\nconst contextData = $node['Preparar Contexto para LLM'].json;\n\n// Timestamp de processamento\nconst webhookHeaders = $node['Webhook - Recebe Tarefa'].json.headers;\nconst requestTime = webhookHeaders['x-request-time'] ? new Date(webhookHeaders['x-request-time']).getTime() : Date.now();\nconst processingTime = Date.now() - requestTime;\n\n// Estruturar resposta final\nconst response = {\n  // IdentificaÃ§Ã£o da tarefa\n  task_id: contextData.task_id,\n  agent_name: 'ECON',\n  status: 'success',\n  \n  // AnÃ¡lise gerada\n  analysis: {\n    text: llmResponse,\n    summary: llmResponse.split('**RESUMO EXECUTIVO**')[1]?.split('**')[0]?.trim() || 'AnÃ¡lise econÃ´mica completa gerada.',\n    territory: {\n      id: contextData.territory_id,\n      name: contextData.territory_name\n    },\n    statistics: contextData.statistics\n  },\n  \n  // Metadados\n  metadata: {\n    processing_time_ms: processingTime,\n    data_sources: contextData.metadata.data_sources,\n    time_range: contextData.metadata.time_range,\n    years_analyzed: contextData.metadata.years_analyzed,\n    last_data_update: contextData.metadata.last_update,\n    model_used: 'gpt-4o-mini',\n    confidence_score: 0.92, // Score fixo para MVP, futuramente pode ser calculado\n    generated_at: new Date().toISOString()\n  },\n  \n  // Dados brutos (para debug/auditoria)\n  raw_data: contextData.raw_data\n};\n\nreturn [{ json: response }];\n\n// ========================================\n// NOTAS SOBRE ESTRUTURA DA RESPOSTA V2\n// ========================================\n// A resposta segue padrÃ£o definido na arquitetura:\n// - task_id: Para rastreamento\n// - agent_name: Identifica qual agente gerou\n// - status: success/error\n// - analysis: ConteÃºdo principal\n// - metadata: InformaÃ§Ãµes sobre processamento\n// - raw_data: Dados originais (opcional, para debug)\n//\n// MUDANÃ‡AS V2:\n// - Melhor tratamento de headers (fallback para Date.now())\n// - ExtraÃ§Ã£o mais robusta do resumo executivo"
      },
      "id": "28e1b7d9-34b3-476e-a191-2e2908712e8f",
      "name": "Estruturar Resposta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        832,
        0
      ],
      "notes": "FUNÃ‡ÃƒO: Consolidar anÃ¡lise do LLM com metadados em resposta estruturada.\n\nATUALIZAÃ‡Ã•ES V2:\n- typeVersion: 1 â†’ 2 (versÃ£o mais recente)\n- Melhor tratamento de headers (fallback)\n- ExtraÃ§Ã£o mais robusta do resumo\n\nO QUE FAZ:\n1. Extrai texto da anÃ¡lise gerada pelo LLM\n2. Recupera dados do nÃ³ 'Preparar Contexto'\n3. Calcula tempo de processamento\n4. Extrai resumo executivo da anÃ¡lise\n5. Monta objeto JSON estruturado com:\n   - IdentificaÃ§Ã£o (task_id, agent_name, status)\n   - AnÃ¡lise (texto completo, resumo, estatÃ­sticas)\n   - Metadados (tempo, fontes, modelo, confianÃ§a)\n   - Dados brutos (para auditoria)\n\nPOR QUE ESTRUTURAR?\n- Padroniza resposta entre todos os agentes\n- Facilita consolidaÃ§Ã£o pelo Orquestrador\n- Permite rastreamento e auditoria\n- Fornece metadados Ãºteis (tempo, fontes, confianÃ§a)\n\nESTRUTURA DA RESPOSTA:\n{\n  \"task_id\": \"uuid-12345\",\n  \"agent_name\": \"ECON\",\n  \"status\": \"success\",\n  \"analysis\": {\n    \"text\": \"AnÃ¡lise completa em Markdown\",\n    \"summary\": \"Resumo executivo\",\n    \"territory\": {\"id\": 1, \"name\": \"Palmas\"},\n    \"statistics\": {...}\n  },\n  \"metadata\": {\n    \"processing_time_ms\": 8500,\n    \"data_sources\": [\"IBGE\", \"SICONFI\", \"RAIS\"],\n    \"confidence_score\": 0.92,\n    ...\n  }\n}\n\nCONFIANCE SCORE:\n- Atualmente fixo em 0.92 (MVP)\n- Futuramente pode ser calculado com base em:\n  â€¢ Completude dos dados\n  â€¢ Idade dos dados\n  â€¢ ConsistÃªncia entre fontes"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO knowledge_base (\n  territory_id,\n  dimension,\n  content,\n  summary,\n  confidence_score,\n  metadata,\n  analysis_type,\n  embedding,\n  generated_by\n)\nVALUES (\n  '{{ $json.territory_id }}',\n  'economic',\n  $${{ $json.analysis_content }}$$,\n  $${{ $json.analysis_summary }}$$,\n  {{ $json.confidence_score }},\n  '{{ $json.metadata }}'::jsonb,\n  'diagnostic',\n  '',\n  'WF-AGENT-ECON'\n);",
        "options": {
          "queryBatching": "transaction"
        }
      },
      "id": "c1df28cc-72d9-4349-b7b7-c689706aaf3c",
      "name": "Salvar AnÃ¡lise no PostgreSQL",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1184,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "SVnYhSNx3vXIzoYk",
          "name": "Postgres Replit"
        }
      },
      "onError": "continueErrorOutput",
      "notes": "FUNÃ‡ÃƒO: Salvar anÃ¡lise gerada na tabela 'knowledge_base' do PostgreSQL.\n\nATUALIZAÃ‡Ã•ES V2:\n- typeVersion: 1 â†’ 2.5 (versÃ£o mais recente)\n- Query Parameters: Usa $1, $2, $3, $4, $5 (prepared statements)\n- Query Batching: 'transaction' (garante atomicidade)\n- RETURNING: Retorna dados da linha inserida/atualizada\n\nO QUE FAZ:\n1. Insere nova anÃ¡lise na tabela 'knowledge_base'\n2. Se jÃ¡ existe anÃ¡lise para o mesmo territÃ³rio/dimensÃ£o, atualiza (UPSERT)\n3. Salva:\n   - territory_id: $1 (ID do territÃ³rio analisado)\n   - dimension: 'economic'\n   - analysis_type: 'single' (anÃ¡lise de um territÃ³rio)\n   - content: $2 (Texto completo da anÃ¡lise)\n   - summary: $3 (Resumo executivo)\n   - key_insights: $4 (EstatÃ­sticas em JSON)\n   - metadata: $5 (Metadados em JSON)\n   - created_at/updated_at: Timestamps\n4. RETURNING: Retorna ID e dados da anÃ¡lise salva\n\nBENEFÃCIOS DO PREPARED STATEMENT:\n- Previne SQL injection\n- Melhor performance\n- Tratamento automÃ¡tico de aspas e caracteres especiais\n- ConversÃ£o automÃ¡tica de tipos (::jsonb)\n\nPOR QUE SALVAR?\n- CACHE: Evita gerar mesma anÃ¡lise mÃºltiplas vezes\n- RAG: AnÃ¡lises anteriores servem de contexto para futuras\n- AUDITORIA: HistÃ³rico de anÃ¡lises geradas\n- DASHBOARD: Dashboard pode consultar anÃ¡lises rapidamente\n\nON CONFLICT (UPSERT):\n- Se anÃ¡lise jÃ¡ existe para o territÃ³rio/dimensÃ£o, ATUALIZA\n- Se nÃ£o existe, INSERE nova\n- Garante que sempre temos versÃ£o mais recente\n\nCHAVE ÃšNICA:\n- (territory_id, dimension, analysis_type)\n- Exemplo: (1, 'economic', 'single')\n- Garante que nÃ£o duplicamos anÃ¡lises\n\nFUTURO - EMBEDDINGS:\nEm versÃ£o futura, tambÃ©m salvaremos embedding vetorial:\n- Gerar embedding do texto com OpenAI Embeddings\n- Salvar na coluna 'embedding' (tipo VECTOR)\n- Permite busca semÃ¢ntica (RAG)\n\nTEMPO DE EXECUÃ‡ÃƒO:\n- TÃ­pico: <500ms\n- Depende de:\n  â€¢ Tamanho do texto\n  â€¢ Carga no banco de dados\n  â€¢ Ãndices existentes"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"task_id\": \"={{ $json.task_id || 'unknown' }}\",\n  \"agent_name\": \"ECON\",\n  \"status\": \"error\",\n  \"error\": {\n    \"message\": \"={{ $json.error || 'Erro ao processar tarefa' }}\",\n    \"code\": \"PROCESSING_ERROR\"\n  },\n  \"metadata\": {\n    \"timestamp\": \"={{ new Date().toISOString() }}\",\n    \"processing_time_ms\": 0\n  }\n}\n",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1392,
        0
      ],
      "id": "83fc7cc6-95cb-4bd6-8478-09148f784b60",
      "name": "Respond to Webhook",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "{\n  \"task_id\": \"={{ $json.task_id || 'unknown' }}\",\n  \"agent_name\": \"ECON\",\n  \"status\": \"error\",\n  \"error\": {\n    \"message\": \"={{ $json.error?.message || $json.message || 'Erro ao processar tarefa' }}\",\n    \"code\": \"PROCESSING_ERROR\",\n    \"details\": \"={{ JSON.stringify($json) }}\"\n  },\n  \"metadata\": {\n    \"timestamp\": \"={{ new Date().toISOString() }}\",\n    \"processing_time_ms\": 0\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        480,
        240
      ],
      "id": "e0419455-ff46-4eaf-a687-7691066e2125",
      "name": "Responder Erro",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// NÃ“: PREPARAR DADOS PARA SALVAR (V2 - RESILIENTE)\n// Framework de InteligÃªncia Territorial V6.0 - Workflow V5\n// ============================================================================\n// FUNÃ‡ÃƒO: Preparar dados da anÃ¡lise para salvar no PostgreSQL\n// INPUT: Estruturar Resposta + Normalizar Entrada\n// OUTPUT: Objeto com todos os campos necessÃ¡rios para INSERT\n// ============================================================================\n\n// Pega os dados do nÃ³ \"Estruturar Resposta\" (nÃ³ anterior)\nconst structuredData = $input.first().json;\n\n// Pega os dados normalizados do webhook\nconst normalizedData = $items(\"Normalizar Entrada\")[0].json;\n\n// ============================================================================\n// EXTRAÃ‡ÃƒO SEGURA DE DADOS\n// ============================================================================\n\n// Dados da anÃ¡lise estruturada\nconst taskId = structuredData.task_id || \"unknown\";\nconst agentName = structuredData.agent_name || \"ECON\";\nconst analysisText = structuredData.analysis?.text || \"\";\nconst analysisSummary = structuredData.analysis?.summary || \"AnÃ¡lise gerada\";\nconst territoryId = structuredData.analysis?.territory?.id || normalizedData.territory_id;\nconst territoryName = structuredData.analysis?.territory?.name || normalizedData.territory_name;\n\n// Metadados da anÃ¡lise\nconst metadata = structuredData.metadata || {};\nconst modelUsed = metadata.model_used || \"gpt-4o-mini\";\nconst generatedAt = metadata.generated_at || new Date().toISOString();\nconst confidenceScore = metadata.confidence_score || 0.85;\nconst processingTimeMs = metadata.processing_time_ms || 0;\nconst yearsAnalyzed = metadata.years_analyzed || normalizedData.parameters.time_period;\n\n// Dados normalizados do webhook\nconst agentId = normalizedData.agent_id;\nconst analysisType = normalizedData.analysis_type;\nconst userId = normalizedData.user_id;\nconst parameters = normalizedData.parameters || {};\n\n// ============================================================================\n// MONTAGEM DE OBJETOS JSON PARA O BANCO\n// ============================================================================\n\n// Objeto de metadados completo\nconst metadataObject = {\n  task_id: taskId,\n  model_used: modelUsed,\n  generated_at: generatedAt,\n  processing_time_ms: processingTimeMs,\n  years_analyzed: yearsAnalyzed,\n  analysis_type: analysisType,\n  user_id: userId,\n  confidence_score: confidenceScore\n};\n\n// Time range (extrair anos do time_period)\nconst timePeriod = parameters.time_period || \"2019-2023\";\nconst [startYear, endYear] = timePeriod.split(\"-\").map(y => y.trim());\n\nconst timeRangeObject = {\n  start: startYear || \"2019\",\n  end: endYear || \"2023\"\n};\n\n// Data sources\nconst dataSourcesObject = [\n  {\n    type: \"internal_db\",\n    source: \"economic_indicators\",\n    query_date: new Date().toISOString()\n  }\n];\n\n// Indicators used (baseado em focus_areas ou padrÃ£o)\nconst focusAreas = parameters.focus_areas || [\"PIB\", \"emprego\", \"renda\"];\nconst indicatorsUsedObject = focusAreas.map(area => ({\n  name: area,\n  source: \"economic_indicators\"\n}));\n\n// ============================================================================\n// MONTAGEM DO OBJETO FINAL PARA SALVAR\n// ============================================================================\n\nconst finalData = {\n  agent_id: agentId,\n  territory_id: territoryId,\n  analysis_content: analysisText,\n  analysis_summary: analysisSummary,\n  confidence_score: confidenceScore,\n  metadata: JSON.stringify(metadataObject),\n  time_range: JSON.stringify(timeRangeObject),\n  data_sources: JSON.stringify(dataSourcesObject),\n  indicators_used: JSON.stringify(indicatorsUsedObject)\n};\n\n// ============================================================================\n// VALIDAÃ‡ÃƒO FINAL\n// ============================================================================\n\n// Verificar se campos crÃ­ticos estÃ£o presentes\nconst criticalFields = ['agent_id', 'territory_id', 'analysis_content'];\nconst missingCritical = criticalFields.filter(field => !finalData[field]);\n\nif (missingCritical.length > 0) {\n  throw new Error(`Campos crÃ­ticos ausentes para salvar: ${missingCritical.join(', ')}`);\n}\n\n// ============================================================================\n// RETORNO\n// ============================================================================\n\nreturn {\n  json: finalData\n};\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1008,
        0
      ],
      "id": "ef86a394-d685-4878-a410-ca6fb69336e4",
      "name": "Preparar Dados para Salvar",
      "onError": "continueErrorOutput",
      "notes": "FUNÃ‡ÃƒO: Preparar dados para salvar no PostgreSQL (V2 - RESILIENTE).\n\nMUDANÃ‡AS V2:\n- Usa dados normalizados do nÃ³ 'Normalizar Entrada'\n- ExtraÃ§Ã£o segura com operador ??\n- Valores padrÃ£o para todos os campos\n- ValidaÃ§Ã£o final antes de retornar"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Registrar aprendizado automÃ¡tico a cada 5 anÃ¡lises\nINSERT INTO agent_econ_learning_evolution (\n  agent_id,\n  learning_type,\n  source_analysis_ids,\n  learning_content,\n  confidence_score,\n  metadata,\n  created_at\n)\nSELECT\n  'econ' AS agent_id,\n  'automatic' AS learning_type,\n  '{{ $json.id }}' AS source_analysis_ids,\n  'Aprendizado automÃ¡tico: O agente ECON continua evoluindo sua expertise atravÃ©s da anÃ¡lise contÃ­nua de indicadores econÃ´micos. AnÃ¡lise ID: {{ $json.id }}' AS learning_content,\n  0.75 AS confidence_score,\n  jsonb_build_object(\n    'type', 'automatic_learning',\n    'trigger', 'post_analysis',\n    'analysis_id', '{{ $json.id }}',\n    'territory_id', '{{ $json.territory_id }}',\n    'timestamp', NOW()\n  ) AS metadata,\n  NOW() AS created_at\nWHERE (\n  -- SÃ³ registrar aprendizado a cada 5 anÃ¡lises\n  SELECT COUNT(*) FROM agent_econ_memory WHERE agent_id = 'econ'\n) % 5 = 0\nRETURNING id, agent_id, learning_type, confidence_score, created_at;",
        "options": {}
      },
      "id": "5056c28f-8641-4835-a565-b030c560a353",
      "name": "Registrar Aprendizado AutomÃ¡tico",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1296,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "PLACEHOLDER_POSTGRES_CREDENTIAL_ID",
          "name": "Postgres Neon"
        }
      },
      "notes": "CICLO DE APRENDIZAGEM - PASSO 1: REGISTRAR APRENDIZADO\n\nEste nÃ³ registra um aprendizado automÃ¡tico na Camada 2 (Learning Evolution).\n\nQUANDO EXECUTA:\n- A cada 5 anÃ¡lises do agente ECON (configurÃ¡vel na condiÃ§Ã£o WHERE)\n\nO QUE FAZ:\n1. Conta o total de anÃ¡lises do agente\n2. Se for mÃºltiplo de 5, insere um registro de aprendizado\n3. Retorna o ID do aprendizado criado\n\nCONFIGURAÃ‡ÃƒO:\n- FrequÃªncia: Modificar \"% 5\" para ajustar (ex: % 3 = a cada 3 anÃ¡lises)\n- ConfianÃ§a: 0.75 (75%) para aprendizado automÃ¡tico\n- Tipo: 'automatic' (nÃ£o requer sÃ­ntese LLM)\n\nSAÃDA:\n- id: ID do aprendizado criado\n- agent_id: 'econ'\n- learning_type: 'automatic'\n- confidence_score: 0.75\n- created_at: timestamp da criaÃ§Ã£o"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Atualizar e retornar expertise atual do agente\nSELECT * FROM get_agent_expertise('econ');",
        "options": {}
      },
      "id": "5601a2a3-d38e-4fd9-be16-b023a85c0a79",
      "name": "Atualizar Expertise",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1408,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "PLACEHOLDER_POSTGRES_CREDENTIAL_ID",
          "name": "Postgres Neon"
        }
      },
      "notes": "CICLO DE APRENDIZAGEM - PASSO 2: ATUALIZAR EXPERTISE\n\nEste nÃ³ chama a funÃ§Ã£o do banco que calcula a expertise atual do agente.\n\nFUNÃ‡ÃƒO: get_agent_expertise('econ')\n\nO QUE RETORNA:\n- agent_id: 'econ'\n- learning_count: NÃºmero total de ciclos de aprendizagem\n- expertise_level: NÃ­vel atual (NOVATO, COMPETENTE, PROFICIENTE, AVANCADO, ESPECIALISTA)\n- expertise_value: Valor numÃ©rico da expertise (1-5)\n\nNÃVEIS DE EXPERTISE:\n- NOVATO: 0-10 ciclos\n- COMPETENTE: 11-30 ciclos\n- PROFICIENTE: 31-60 ciclos\n- AVANCADO: 61-100 ciclos\n- ESPECIALISTA: 100+ ciclos\n\nOBSERVAÃ‡ÃƒO:\nEsta funÃ§Ã£o Ã© implementada no banco de dados e atualiza automaticamente\no nÃ­vel de expertise baseado no nÃºmero de aprendizados registrados."
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Registrar evento de ciclo de aprendizagem na auditoria\nINSERT INTO audit_trail (\n  event_type,\n  agent_id,\n  user_id,\n  action,\n  resource_type,\n  status,\n  metadata,\n  created_at\n) VALUES (\n  'learning_cycle_completed',\n  'econ',\n  'system',\n  'automatic_learning',\n  'learning_evolution',\n  'success',\n  jsonb_build_object(\n    'analysis_id', '{{ $('Salvar AnÃ¡lise no PostgreSQL').item.json.id }}',\n    'learning_id', '{{ $('Registrar Aprendizado AutomÃ¡tico').item.json.id }}',\n    'expertise_level', '{{ $('Atualizar Expertise').item.json.expertise_level }}',\n    'type', 'automatic'\n  ),\n  NOW()\n);",
        "options": {}
      },
      "id": "66975f6c-8c63-4e34-a585-f1600838c6cc",
      "name": "Registrar Auditoria do Ciclo",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.5,
      "position": [
        1520,
        0
      ],
      "credentials": {
        "postgres": {
          "id": "PLACEHOLDER_POSTGRES_CREDENTIAL_ID",
          "name": "Postgres Neon"
        }
      },
      "notes": "CICLO DE APRENDIZAGEM - PASSO 3: REGISTRAR AUDITORIA\n\nEste nÃ³ registra o evento de conclusÃ£o do ciclo de aprendizagem na audit_trail.\n\nO QUE REGISTRA:\n- event_type: 'learning_cycle_completed'\n- agent_id: 'econ'\n- user_id: 'system' (processo automÃ¡tico)\n- action: 'automatic_learning'\n- resource_type: 'learning_evolution'\n- status: 'success'\n\nMETADATA INCLUÃDA:\n- analysis_id: ID da anÃ¡lise que iniciou o ciclo\n- learning_id: ID do aprendizado registrado\n- expertise_level: NÃ­vel de expertise apÃ³s o ciclo\n- type: 'automatic'\n\nOBSERVAÃ‡ÃƒO:\nEste registro permite rastrear a evoluÃ§Ã£o do agente ao longo do tempo\ne auditar todos os ciclos de aprendizagem executados."
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook - Recebe Tarefa": {
      "main": [
        [
          {
            "node": "Normalizar Entrada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar Dados PostgreSQL": {
      "main": [
        [
          {
            "node": "Preparar Contexto para LLM",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Contexto para LLM": {
      "main": [
        [
          {
            "node": "Gerar AnÃ¡lise com OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar AnÃ¡lise com OpenAI": {
      "main": [
        [
          {
            "node": "Estruturar Resposta",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Estruturar Resposta": {
      "main": [
        [
          {
            "node": "Preparar Dados para Salvar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Salvar AnÃ¡lise no PostgreSQL": {
      "main": [
        [
          {
            "node": "Registrar Aprendizado AutomÃ¡tico",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Dados para Salvar": {
      "main": [
        [
          {
            "node": "Salvar AnÃ¡lise no PostgreSQL",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Responder Erro",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Aprendizado AutomÃ¡tico": {
      "main": [
        [
          {
            "node": "Atualizar Expertise",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Atualizar Expertise": {
      "main": [
        [
          {
            "node": "Registrar Auditoria do Ciclo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Registrar Auditoria do Ciclo": {
      "main": [
        [
          {
            "node": "Respond to Webhook",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Normalizar Entrada": {
      "main": [
        [
          {
            "node": "Consultar MemÃ³ria e Aprendizados",
            "type": "main",
            "index": 0
          },
          {
            "node": "Consultar Dados PostgreSQL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultar MemÃ³ria e Aprendizados": {
      "main": [
        [
          {
            "node": "Preparar Contexto para LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "4",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "v6.1-multidimensional-d6136551eb6eb1ac3d452dbcd165c5de72dbb472459ed630e41b95c04cec3f3e"
  },
  "id": "3SWHPjT4oLuqLgdb",
  "tags": [
    {
      "name": "Aprendizagem PostgreSQL",
      "id": "learning-postgres"
    }
  ],
  "updatedAt": "2025-11-30T12:00:00.000Z"
}